---
title: Kopieren und Fixieren
ms.date: 03/30/2017
helpviewer_keywords:
- pinning, interop marshaling
- copying, interop marshaling
- interop marshaling, copying
- interop marshaling, pinning
ms.assetid: 0059f576-e460-4e70-b257-668870e420b8
ms.openlocfilehash: f6db7d37293015911c1285d39e19bf7542a7ac59
ms.sourcegitcommit: 559fcfbe4871636494870a8b716bf7325df34ac5
ms.translationtype: HT
ms.contentlocale: de-DE
ms.lasthandoff: 10/30/2019
ms.locfileid: "73123640"
---
# <a name="copying-and-pinning"></a><span data-ttu-id="863e6-102">Kopieren und Fixieren</span><span class="sxs-lookup"><span data-stu-id="863e6-102">Copying and Pinning</span></span>

<span data-ttu-id="863e6-103">Beim Marshalling von Daten kann der Interop-Marshaller die gemarshallten Daten kopieren oder fixieren.</span><span class="sxs-lookup"><span data-stu-id="863e6-103">When marshaling data, the interop marshaler can copy or pin the data being marshaled.</span></span> <span data-ttu-id="863e6-104">Beim Kopieren der Daten wird eine Kopie der Daten aus einem Speicherort an einem anderen Speicherort abgelegt.</span><span class="sxs-lookup"><span data-stu-id="863e6-104">Copying the data places a copy of data from one memory location in another memory location.</span></span> <span data-ttu-id="863e6-105">Die folgende Abbildung veranschaulicht die Unterschiede zwischen dem Kopieren eines Werttyps und dem Kopieren eines Typs, der als Verweis von einem verwalteten Speicher zu einem nicht verwalteten Speicher übergeben wird.</span><span class="sxs-lookup"><span data-stu-id="863e6-105">The following illustration shows the differences between copying a value type and copying a type passed by reference from managed to unmanaged memory.</span></span>

![Diagramm, das zeigt, wie Wert- und Verweistypen kopiert werden.](./media/copying-and-pinning/interop-marshal-copy.gif)

<span data-ttu-id="863e6-107">Als Wert übergebene Methodenargumente werden in einen nicht verwalteten Code als Werte im Stapel gemarshallt.</span><span class="sxs-lookup"><span data-stu-id="863e6-107">Method arguments passed by value are marshaled to unmanaged code as values on the stack.</span></span> <span data-ttu-id="863e6-108">Der Kopiervorgang wird direkt ausgeführt.</span><span class="sxs-lookup"><span data-stu-id="863e6-108">The copying process is direct.</span></span> <span data-ttu-id="863e6-109">Als Verweis übergebene Argumente werden als Zeiger im Stapel übergeben.</span><span class="sxs-lookup"><span data-stu-id="863e6-109">Arguments passed by reference are passed as pointers on the stack.</span></span> <span data-ttu-id="863e6-110">Auch Verweistypen werden als Wert und als Verweis übergebenen.</span><span class="sxs-lookup"><span data-stu-id="863e6-110">Reference types are also passed by value and by reference.</span></span> <span data-ttu-id="863e6-111">Die folgende Abbildung zeigt, dass als Wert übergebene Verweistypen entweder kopiert oder fixiert werden:</span><span class="sxs-lookup"><span data-stu-id="863e6-111">As the following illustration shows, reference types passed by value are either copied or pinned:</span></span>

![Diagramm mit Verweistypen, die nach Wert und Verweis übergeben werden.](./media/copying-and-pinning/interop-marshal-reference-pin.gif)

<span data-ttu-id="863e6-113">Beim Fixieren werden die Daten vorübergehend an ihrem aktuellen Speicherort gesperrt. Dadurch können sie nicht vom Garbage Collector der Common Language Runtime verschoben werden.</span><span class="sxs-lookup"><span data-stu-id="863e6-113">Pinning temporarily locks the data in its current memory location, thus keeping it from being relocated by the common language runtime's garbage collector.</span></span> <span data-ttu-id="863e6-114">Der Marshaller fixiert die Daten, um den Aufwand beim Kopieren zu reduzieren und die Leistung zu verbessern.</span><span class="sxs-lookup"><span data-stu-id="863e6-114">The marshaler pins data to reduce the overhead of copying and enhance performance.</span></span> <span data-ttu-id="863e6-115">Ob Daten während des Marshallingvorgangs kopiert oder fixiert werden, wird durch den Datentyp bestimmt.</span><span class="sxs-lookup"><span data-stu-id="863e6-115">The type of the data determines whether it is copied or pinned during the marshaling process.</span></span>  <span data-ttu-id="863e6-116">Beim Marshalling für Objekte, wie z.B. <xref:System.String>, werden die Daten automatisch fixiert. Sie können jedoch mithilfe der <xref:System.Runtime.InteropServices.GCHandle>-Klasse den Speicher auch manuell fixieren.</span><span class="sxs-lookup"><span data-stu-id="863e6-116">Pinning is automatically performed during marshaling for objects such as <xref:System.String>, however you can also manually pin memory using the <xref:System.Runtime.InteropServices.GCHandle> class.</span></span>

## <a name="formatted-blittable-classes"></a><span data-ttu-id="863e6-117">Formatierte blitfähige Klassen</span><span class="sxs-lookup"><span data-stu-id="863e6-117">Formatted Blittable Classes</span></span>

<span data-ttu-id="863e6-118">Formatierte [blitfähige](blittable-and-non-blittable-types.md) Klassen verfügen über ein festes Layout (formatiert) und eine allgemeine Darstellung der Daten im verwalteten und im nicht verwalteten Speicher.</span><span class="sxs-lookup"><span data-stu-id="863e6-118">Formatted [blittable](blittable-and-non-blittable-types.md) classes have fixed layout (formatted) and common data representation in both managed and unmanaged memory.</span></span> <span data-ttu-id="863e6-119">Wenn diese Typen gemarshallt werden müssen, wird ein Zeiger auf das Objekt im Heap direkt an den Aufgerufenen übergeben.</span><span class="sxs-lookup"><span data-stu-id="863e6-119">When these types require marshaling, a pointer to the object in the heap is passed to the callee directly.</span></span> <span data-ttu-id="863e6-120">Der Aufgerufene kann den Inhalt des Speicherorts ändern, auf den der Zeiger verweist.</span><span class="sxs-lookup"><span data-stu-id="863e6-120">The callee can change the contents of the memory location being referenced by the pointer.</span></span>

> [!NOTE]
> <span data-ttu-id="863e6-121">Der Aufgerufene kann den Speicherinhalt ändern, wenn der Parameter als Ausgabe- oder Ein-/Ausgabeparameter markiert ist. Im Gegensatz dazu sollte der Aufgerufene den Inhalt nicht ändern, wenn der Parameter zum Marshallen als Eingabeparameter festgelegt ist. Dies ist die Standardeinstellung für formatierte blitfähige Typen.</span><span class="sxs-lookup"><span data-stu-id="863e6-121">The callee can change the memory contents if the parameter is marked Out or In/Out. In contrast, the callee should avoid changing the contents when the parameter is set to marshal as In, which is the default for formatted blittable types.</span></span> <span data-ttu-id="863e6-122">Das Ändern von Eingabeobjekten kann zu Problemen führen, wenn die gleiche Klasse in eine Typbibliothek exportiert und auch für apartmentübergreifende Aufrufe verwendet wird.</span><span class="sxs-lookup"><span data-stu-id="863e6-122">Modifying an In object generates problems when the same class is exported to a type library and used to make cross-apartment calls.</span></span>

## <a name="formatted-non-blittable-classes"></a><span data-ttu-id="863e6-123">Formatierte nicht blitfähige Klassen</span><span class="sxs-lookup"><span data-stu-id="863e6-123">Formatted Non-Blittable Classes</span></span>

<span data-ttu-id="863e6-124">Formatierte [nicht blitfähige](blittable-and-non-blittable-types.md) Klassen verfügen über ein festes Layout (formatiert), doch die Daten werden im verwalteten und im nicht verwalteten Speicher unterschiedlich dargestellt.</span><span class="sxs-lookup"><span data-stu-id="863e6-124">Formatted [non-blittable](blittable-and-non-blittable-types.md) classes have fixed layout (formatted) but the data representation is different in managed and unmanaged memory.</span></span> <span data-ttu-id="863e6-125">Unter den folgenden Bedingungen kann eine Umwandlung der Daten erforderlich sein:</span><span class="sxs-lookup"><span data-stu-id="863e6-125">The data can require transformation under the following conditions:</span></span>

- <span data-ttu-id="863e6-126">Wenn eine nicht blitfähige Klasse als Wert gemarshallt wird, erhält der Aufgerufene einen Zeiger auf eine Kopie der Datenstruktur.</span><span class="sxs-lookup"><span data-stu-id="863e6-126">If a non-blittable class is marshaled by value, the callee receives a pointer to a copy of the data structure.</span></span>

- <span data-ttu-id="863e6-127">Wenn eine nicht blitfähige Klasse als Verweis gemarshallt wird, erhält der Aufgerufene einen Zeiger auf einen Zeiger auf eine Kopie der Datenstruktur.</span><span class="sxs-lookup"><span data-stu-id="863e6-127">If a non-blittable class is marshaled by reference, the callee receives a pointer to a pointer to a copy of the data structure.</span></span>

- <span data-ttu-id="863e6-128">Wenn das <xref:System.Runtime.InteropServices.InAttribute>-Attribut festgelegt ist, wird diese Kopie immer mit dem Zustand der Instanz initialisiert. Das Marshalling erfolgt nach Bedarf.</span><span class="sxs-lookup"><span data-stu-id="863e6-128">If the <xref:System.Runtime.InteropServices.InAttribute> attribute is set, this copy is always initialized with the instance's state, marshaling as necessary.</span></span>

- <span data-ttu-id="863e6-129">Wenn das <xref:System.Runtime.InteropServices.OutAttribute>-Attribut festgelegt ist, wird der Zustand bei der Rückgabe immer zurück in die Instanz kopiert. Das Marshalling erfolgt nach Bedarf.</span><span class="sxs-lookup"><span data-stu-id="863e6-129">If the <xref:System.Runtime.InteropServices.OutAttribute> attribute is set, the state is always copied back to the instance on return, marshaling as necessary.</span></span>

- <span data-ttu-id="863e6-130">Wenn sowohl **InAttribute** als auch **OutAttribute** festgelegt sind, werden beide Kopien benötigt.</span><span class="sxs-lookup"><span data-stu-id="863e6-130">If both **InAttribute** and **OutAttribute** are set, both copies are required.</span></span> <span data-ttu-id="863e6-131">Wenn kein Attribut verwendet wird, kann der Marshaller durch Beseitigen beider Kopien eine Optimierung vornehmen.</span><span class="sxs-lookup"><span data-stu-id="863e6-131">If either attribute is omitted, the marshaler can optimize by eliminating either copy.</span></span>

## <a name="reference-types"></a><span data-ttu-id="863e6-132">Verweistypen</span><span class="sxs-lookup"><span data-stu-id="863e6-132">Reference Types</span></span>

<span data-ttu-id="863e6-133">Verweistypen können als Wert oder als Verweis übergeben werden.</span><span class="sxs-lookup"><span data-stu-id="863e6-133">Reference types can be passed by value or by reference.</span></span> <span data-ttu-id="863e6-134">Werden sie als Wert übergeben, wird ein Zeiger auf den Typ im Stapel übergeben.</span><span class="sxs-lookup"><span data-stu-id="863e6-134">When they are passed by value, a pointer to the type is passed on the stack.</span></span> <span data-ttu-id="863e6-135">Werden sie als Verweis übergeben, wird ein Zeiger auf einen Zeiger auf den Typ im Stapel übergeben.</span><span class="sxs-lookup"><span data-stu-id="863e6-135">When passed by reference, a pointer to a pointer to the type is passed on the stack.</span></span>

<span data-ttu-id="863e6-136">Verweistypen weisen das folgende bedingte Verhalten auf:</span><span class="sxs-lookup"><span data-stu-id="863e6-136">Reference types have the following conditional behavior:</span></span>

- <span data-ttu-id="863e6-137">Wird ein Verweistyp als Wert übergeben, und verfügt er über Member nicht blitfähiger Typen, werden die Typen zweimal konvertiert:</span><span class="sxs-lookup"><span data-stu-id="863e6-137">If a reference type is passed by value and it has members of non-blittable types, the types are converted twice:</span></span>

  - <span data-ttu-id="863e6-138">bei der Übergabe eines Arguments an die nicht verwaltete Seite</span><span class="sxs-lookup"><span data-stu-id="863e6-138">When an argument is passed to the unmanaged side.</span></span>

  - <span data-ttu-id="863e6-139">bei der Rückgabe aus dem Aufruf</span><span class="sxs-lookup"><span data-stu-id="863e6-139">On return from the call.</span></span>

  <span data-ttu-id="863e6-140">Diese Typen werden als Eingabeparameter gemarshallt, um unnötiges Kopieren und Konvertieren zu vermeiden.</span><span class="sxs-lookup"><span data-stu-id="863e6-140">To avoid unnecessarily copying and conversion, these types are marshaled as In parameters.</span></span> <span data-ttu-id="863e6-141">Damit der Aufrufer die durch den Aufgerufenen vorgenommenen Änderungen sehen kann, müssen Sie die Attribute **InAttribute** und **OutAttribute** explizit auf ein Argument anwenden.</span><span class="sxs-lookup"><span data-stu-id="863e6-141">You must explicitly apply the **InAttribute** and **OutAttribute** attributes to an argument for the caller to see changes made by the callee.</span></span>

- <span data-ttu-id="863e6-142">Wird ein Verweistyp als Wert übergeben, und verfügt er nur über Member blitfähiger Typen, kann er während des Marshallings fixiert werden. Alle vom Aufgerufenen an den Membern des Typs vorgenommen Änderungen sind für den Aufrufer sichtbar.</span><span class="sxs-lookup"><span data-stu-id="863e6-142">If a reference type is passed by value and it has only members of blittable types, it can be pinned during marshaling and any changes made to the members of the type by the callee are seen by the caller.</span></span> <span data-ttu-id="863e6-143">Wenn Sie dieses Verhalten wünschen, wenden Sie die Attribute **InAttribute** und **OutAttribute** explizit an.</span><span class="sxs-lookup"><span data-stu-id="863e6-143">Apply **InAttribute** and **OutAttribute** explicitly if you want this behavior.</span></span> <span data-ttu-id="863e6-144">Ohne diese direktionalen Attribute werden keine direktionalen Informationen vom Interop-Marshaller in die Typbibliothek exportiert (der Export erfolgt standardmäßig als Eingabeparameter). Dies kann zu Problemen beim apartmentübergreifenden COM-Marshalling führen.</span><span class="sxs-lookup"><span data-stu-id="863e6-144">Without these directional attributes, the interop marshaler does not export directional information to the type library (it exports as In, which is the default) and this can cause problems with COM cross-apartment marshaling.</span></span>

- <span data-ttu-id="863e6-145">Wird ein Verweistyp als Verweis übergeben, wird er standardmäßig als Ein-/Ausgabeparameter gemarshallt.</span><span class="sxs-lookup"><span data-stu-id="863e6-145">If a reference type is passed by reference, it will be marshaled as In/Out by default.</span></span>

## <a name="systemstring-and-systemtextstringbuilder"></a><span data-ttu-id="863e6-146">System.String und System.Text.StringBuilder</span><span class="sxs-lookup"><span data-stu-id="863e6-146">System.String and System.Text.StringBuilder</span></span>

<span data-ttu-id="863e6-147">Wenn Daten als Wert oder als Verweis in einen nicht verwalteten Code gemarshallt werden, kopiert der Marshaller die Daten in der Regel in einen sekundären Puffer (wobei Zeichensätze während des Kopiervorgangs eventuell konvertiert werden) und übergibt an den Aufgerufenen einen Verweis auf den Puffer.</span><span class="sxs-lookup"><span data-stu-id="863e6-147">When data is marshaled to unmanaged code by value or by reference, the marshaler typically copies the data to a secondary buffer (possibly converting character sets during the copy) and passes a reference to the buffer to the callee.</span></span> <span data-ttu-id="863e6-148">Der Verweis wird immer mit **CoTaskMemAlloc** zugeordnet. Außer es handelt sich um ein **BSTR**, das mit **SysAllocString** zugeordnet wird.</span><span class="sxs-lookup"><span data-stu-id="863e6-148">Unless the reference is a **BSTR** allocated with **SysAllocString**, the reference is always allocated with **CoTaskMemAlloc**.</span></span>

<span data-ttu-id="863e6-149">Wenn beide Zeichenfolgentypen als Wert gemarshallt werden (wie etwa bei einer Unicode-Zeichenfolge), übergibt der Marshaller dem Aufgerufenen einen direkten Zeiger auf die verwalteten Zeichenfolgen im internen Unicode-Puffer, anstatt sie in einen neuen Puffer zu kopieren.</span><span class="sxs-lookup"><span data-stu-id="863e6-149">As an optimization when either string type is marshaled by value (such as a Unicode character string), the marshaler passes the callee a direct pointer to managed strings in the internal Unicode buffer instead of copying it to a new buffer.</span></span>

> [!CAUTION]
> <span data-ttu-id="863e6-150">Wird eine Zeichenfolge als Wert übergeben, darf der Aufgerufene den vom Marshaller übergebenen Verweis nie ändern.</span><span class="sxs-lookup"><span data-stu-id="863e6-150">When a string is passed by value, the callee must never alter the reference passed by the marshaler.</span></span> <span data-ttu-id="863e6-151">Andernfalls kann der verwaltete Heap beschädigt werden.</span><span class="sxs-lookup"><span data-stu-id="863e6-151">Doing so can corrupt the managed heap.</span></span>

<span data-ttu-id="863e6-152">Wenn ein <xref:System.String?displayProperty=nameWithType> als Verweis übergeben wird, kopiert der Marshaller den Inhalt der Zeichenfolge vor dem Aufruf in einen sekundären Puffer.</span><span class="sxs-lookup"><span data-stu-id="863e6-152">When a <xref:System.String?displayProperty=nameWithType> is passed by reference, the marshaler copies the contents the string to a secondary buffer before making the call.</span></span> <span data-ttu-id="863e6-153">Anschließend kopiert er den Inhalt des Puffers bei der Rückgabe aus dem Aufruf in eine neue Zeichenfolge.</span><span class="sxs-lookup"><span data-stu-id="863e6-153">It then copies the contents of the buffer into a new string on return from the call.</span></span> <span data-ttu-id="863e6-154">So wird sichergestellt, dass die unveränderliche verwaltete Zeichenfolge unverändert bleibt.</span><span class="sxs-lookup"><span data-stu-id="863e6-154">This technique ensures that the immutable managed string remains unaltered.</span></span>

<span data-ttu-id="863e6-155">Wenn ein <xref:System.Text.StringBuilder?displayProperty=nameWithType> als Wert übergeben wird, übergibt der Marshaller dem Aufrufer direkt einen Verweis auf den internen Puffer von **StringBuilder**.</span><span class="sxs-lookup"><span data-stu-id="863e6-155">When a <xref:System.Text.StringBuilder?displayProperty=nameWithType> is passed by value, the marshaler passes a reference to the internal buffer of the **StringBuilder** directly to the caller.</span></span> <span data-ttu-id="863e6-156">Aufrufer und Aufgerufener müssen bei der Größe des Puffers übereinstimmen.</span><span class="sxs-lookup"><span data-stu-id="863e6-156">The caller and callee must agree on the size of the buffer.</span></span> <span data-ttu-id="863e6-157">Der Aufrufer ist für das Erstellen von **StringBuilder** in einer angemessenen Länge zuständig.</span><span class="sxs-lookup"><span data-stu-id="863e6-157">The caller is responsible for creating a **StringBuilder** of adequate length.</span></span> <span data-ttu-id="863e6-158">Der Aufgerufene muss die erforderlichen Vorsichtsmaßnahmen treffen, um einen Pufferüberlauf zu verhindern.</span><span class="sxs-lookup"><span data-stu-id="863e6-158">The callee must take the necessary precautions to ensure that the buffer is not overrun.</span></span> <span data-ttu-id="863e6-159">**StringBuilder** stellt eine Ausnahme zu der Regel dar, dass als Wert übergebene Verweistypen standardmäßig als Eingabeparameter übergeben werden.</span><span class="sxs-lookup"><span data-stu-id="863e6-159">**StringBuilder** is an exception to the rule that reference types passed by value are passed as In parameters by default.</span></span> <span data-ttu-id="863e6-160">Es wird immer als Ein-/Ausgabeparameter übergeben.</span><span class="sxs-lookup"><span data-stu-id="863e6-160">It is always passed as In/Out.</span></span>

## <a name="see-also"></a><span data-ttu-id="863e6-161">Siehe auch</span><span class="sxs-lookup"><span data-stu-id="863e6-161">See also</span></span>

- [<span data-ttu-id="863e6-162">Default Marshaling Behavior (Standardmäßiges Marshallingverhalten)</span><span class="sxs-lookup"><span data-stu-id="863e6-162">Default Marshaling Behavior</span></span>](default-marshaling-behavior.md)
- <span data-ttu-id="863e6-163">[Direktionale Attribute](https://docs.microsoft.com/previous-versions/dotnet/netframework-4.0/77e6taeh(v=vs.100))</span><span class="sxs-lookup"><span data-stu-id="863e6-163">[Directional Attributes](https://docs.microsoft.com/previous-versions/dotnet/netframework-4.0/77e6taeh(v=vs.100))</span></span>
- [<span data-ttu-id="863e6-164">Interop Marshaling (Interop-Marshalling)</span><span class="sxs-lookup"><span data-stu-id="863e6-164">Interop Marshaling</span></span>](interop-marshaling.md)
