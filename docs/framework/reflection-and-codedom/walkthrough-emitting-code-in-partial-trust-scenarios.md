---
title: 'Exemplarische Vorgehensweise: Ausgeben von Code in Szenarios mit teilweiser Vertrauenswürdigkeit'
ms.date: 03/30/2017
dev_langs:
- csharp
- vb
helpviewer_keywords:
- reflection emit, anonymously hosted dynamic methods
- partial trust, reflection
- partial trust, emitting dynamic methods
- reflection emit, partial trust scenarios
- anonymously hosted dynamic methods [.NET Framework]
- emitting dynamic assemblies,partial trust scenarios
- reflection emit, dynamic methods
- dynamic methods
ms.assetid: c45be261-2a9d-4c4e-9bd6-27f0931b7d25
ms.openlocfilehash: fd420c9754494b95c55df403edec87743572db03
ms.sourcegitcommit: 559fcfbe4871636494870a8b716bf7325df34ac5
ms.translationtype: HT
ms.contentlocale: de-DE
ms.lasthandoff: 10/30/2019
ms.locfileid: "73129993"
---
# <a name="walkthrough-emitting-code-in-partial-trust-scenarios"></a><span data-ttu-id="eaecf-102">Exemplarische Vorgehensweise: Ausgeben von Code in Szenarios mit teilweiser Vertrauenswürdigkeit</span><span class="sxs-lookup"><span data-stu-id="eaecf-102">Walkthrough: Emitting Code in Partial Trust Scenarios</span></span>

<span data-ttu-id="eaecf-103">Die Reflektionsausgabe verwendet für volle oder teilweise Vertrauenswürdigkeit den gleichen API-Satz, für teilweise vertrauenswürdigen Code erfordern einige Funktionen allerdings besondere Berechtigungen.</span><span class="sxs-lookup"><span data-stu-id="eaecf-103">Reflection emit uses the same API set in full or partial trust, but some features require special permissions in partially trusted code.</span></span> <span data-ttu-id="eaecf-104">Außerdem verfügt die Reflektionsausgabe über eine Funktion für anonym gehostete dynamische Methoden, die zur Verwendung mit teilweiser Vertrauenswürdigkeit und sicherheitstransparenten Assemblys vorgesehen ist.</span><span class="sxs-lookup"><span data-stu-id="eaecf-104">In addition, reflection emit has a feature, anonymously hosted dynamic methods, that is designed to be used with partial trust and by security-transparent assemblies.</span></span>

> [!NOTE]
> <span data-ttu-id="eaecf-105">Vor .NET Framework 3.5 war zur Ausgabe von Code <xref:System.Security.Permissions.ReflectionPermission> mit dem <xref:System.Security.Permissions.ReflectionPermissionFlag.ReflectionEmit?displayProperty=nameWithType>-Flag erforderlich.</span><span class="sxs-lookup"><span data-stu-id="eaecf-105">Before .NET Framework 3.5, emitting code required <xref:System.Security.Permissions.ReflectionPermission> with the <xref:System.Security.Permissions.ReflectionPermissionFlag.ReflectionEmit?displayProperty=nameWithType> flag.</span></span> <span data-ttu-id="eaecf-106">Diese Berechtigung ist standardmäßig im benannten `FullTrust`- und `Intranet`-Berechtigungssatz enthalten, jedoch nicht im `Internet`-Berechtigungssatz.</span><span class="sxs-lookup"><span data-stu-id="eaecf-106">This permission is included by default in the `FullTrust` and `Intranet` named permission sets, but not in the `Internet` permission set.</span></span> <span data-ttu-id="eaecf-107">Daher kann eine Bibliothek nur mit teilweiser Vertrauenswürdigkeit verwendet werden, wenn sie über das <xref:System.Security.SecurityCriticalAttribute>-Attribut verfügt und eine <xref:System.Security.PermissionSet.Assert%2A>-Methode für <xref:System.Security.Permissions.ReflectionPermissionFlag.ReflectionEmit> ausgeführt hat.</span><span class="sxs-lookup"><span data-stu-id="eaecf-107">Therefore, a library could be used from partial trust only if it had the <xref:System.Security.SecurityCriticalAttribute> attribute and also executed an <xref:System.Security.PermissionSet.Assert%2A> method for <xref:System.Security.Permissions.ReflectionPermissionFlag.ReflectionEmit>.</span></span> <span data-ttu-id="eaecf-108">Diese Bibliotheken erfordern einen sorgfältigen Sicherheitsreview, da Codierungsfehler zu Sicherheitslücken führen können.</span><span class="sxs-lookup"><span data-stu-id="eaecf-108">Such libraries require careful security review because coding errors could result in security holes.</span></span> <span data-ttu-id="eaecf-109">In .NET Framework 3.5 ist es möglich, Code in teilweise vertrauenswürdigen Szenarios ohne Sicherheitsanforderungen auszugeben, da das Generieren von Code an sich keinen privilegierten Vorgang darstellt.</span><span class="sxs-lookup"><span data-stu-id="eaecf-109">The .NET Framework 3.5 allows code to be emitted in partial trust scenarios without issuing any security demands, because generating code is not inherently a privileged operation.</span></span> <span data-ttu-id="eaecf-110">Das bedeutet, dass der generierte Code nicht mehr Berechtigungen aufweist als die Assembly, die ihn ausgibt.</span><span class="sxs-lookup"><span data-stu-id="eaecf-110">That is, the generated code has no more permissions than the assembly that emits it.</span></span> <span data-ttu-id="eaecf-111">Bibliotheken, die Code ausgeben, können somit sicherheitstransparent sein und setzen keine <xref:System.Security.Permissions.ReflectionPermissionFlag.ReflectionEmit>-Assertion voraus, sodass zum Schreiben einer sicheren Bibliothek keine genaue Sicherheitsüberprüfung erforderlich ist.</span><span class="sxs-lookup"><span data-stu-id="eaecf-111">This enables libraries that emit code to be security-transparent and removes the need to assert <xref:System.Security.Permissions.ReflectionPermissionFlag.ReflectionEmit>, so that writing a secure library does not require such a thorough security review.</span></span>

<span data-ttu-id="eaecf-112">In dieser exemplarischen Vorgehensweise werden die folgenden Aufgaben veranschaulicht:</span><span class="sxs-lookup"><span data-stu-id="eaecf-112">This walkthrough illustrates the following tasks:</span></span>

- <span data-ttu-id="eaecf-113">[Das Einrichten einer einfachen Sandkastenanwendung zum Testen von teilweise vertrauenswürdigem Code](#Setting_up)</span><span class="sxs-lookup"><span data-stu-id="eaecf-113">[Setting up a simple sandbox for testing partially trusted code](#Setting_up).</span></span>

  > [!IMPORTANT]
  > <span data-ttu-id="eaecf-114">Dies ist eine einfache Möglichkeit zum Experimentieren mit teilweise vertrauenswürdigem Code.</span><span class="sxs-lookup"><span data-stu-id="eaecf-114">This is a simple way to experiment with code in partial trust.</span></span> <span data-ttu-id="eaecf-115">Informationen zum Ausführen von Code, der aus nicht vertrauenswürdigen Speicherorten stammt, finden Sie unter [Vorgehensweise: Ausführen von teilweise vertrauenswürdigem Code in einem Sandkasten](../misc/how-to-run-partially-trusted-code-in-a-sandbox.md).</span><span class="sxs-lookup"><span data-stu-id="eaecf-115">To run code that actually comes from untrusted locations, see [How to: Run Partially Trusted Code in a Sandbox](../misc/how-to-run-partially-trusted-code-in-a-sandbox.md).</span></span>

- <span data-ttu-id="eaecf-116">[Ausführen von Code in teilweise vertrauenswürdigen Anwendungsdomänen](#Running_code)</span><span class="sxs-lookup"><span data-stu-id="eaecf-116">[Running code in partially trusted application domains](#Running_code).</span></span>

- <span data-ttu-id="eaecf-117">[Verwenden von anonym gehosteten dynamischen Methoden zum Ausgeben und Ausführen von Code in Szenarios mit teilweiser Vertrauenswürdigkeit](#Using_methods)</span><span class="sxs-lookup"><span data-stu-id="eaecf-117">[Using anonymously hosted dynamic methods to emit and execute code in partial trust](#Using_methods).</span></span>

<span data-ttu-id="eaecf-118">Weitere Informationen zum Ausgeben von Code in Szenarios mit teilweiser Vertrauenswürdigkeit finden Sie unter [Security Issues in Reflection Emit (Sicherheitsaspekte bei der Reflektionsausgabe)](security-issues-in-reflection-emit.md).</span><span class="sxs-lookup"><span data-stu-id="eaecf-118">For more information about emitting code in partial trust scenarios, see [Security Issues in Reflection Emit](security-issues-in-reflection-emit.md).</span></span>

<span data-ttu-id="eaecf-119">Eine vollständige Auflistung des in diesen Verfahren dargestellten Codes finden Sie im [Beispielabschnitt](#Example) am Ende dieser exemplarischen Vorgehensweise.</span><span class="sxs-lookup"><span data-stu-id="eaecf-119">For a complete listing of the code shown in these procedures, see the [Example section](#Example) at the end of this walkthrough.</span></span>

<a name="Setting_up"></a>

## <a name="setting-up-partially-trusted-locations"></a><span data-ttu-id="eaecf-120">Einrichten von teilweise vertrauenswürdigen Speicherorten</span><span class="sxs-lookup"><span data-stu-id="eaecf-120">Setting up Partially Trusted Locations</span></span>

<span data-ttu-id="eaecf-121">Die folgenden beiden Verfahren enthalten Informationen zum Einrichten von Speicherorten, über die teilweise vertrauenswürdiger Code getestet werden kann.</span><span class="sxs-lookup"><span data-stu-id="eaecf-121">The following two procedures show how to set up locations from which you can test code with partial trust.</span></span>

- <span data-ttu-id="eaecf-122">Im ersten Verfahren wird beschrieben, wie Sie eine Sandboxanwendungsdomäne erstellen, in der dem Code Internetberechtigungen zugewiesen werden.</span><span class="sxs-lookup"><span data-stu-id="eaecf-122">The first procedure shows how to create a sandboxed application domain in which code is granted Internet permissions.</span></span>

- <span data-ttu-id="eaecf-123">Im zweiten Verfahren wird beschrieben, wie Sie einer teilweise vertrauenswürdigen Anwendungsdomäne <xref:System.Security.Permissions.ReflectionPermission> mit dem <xref:System.Security.Permissions.ReflectionPermissionFlag.RestrictedMemberAccess?displayProperty=nameWithType>-Flag hinzufügen, um Zugriff auf private Daten in Assemblys mit gleicher oder geringerer Vertrauenswürdigkeit zu ermöglichen.</span><span class="sxs-lookup"><span data-stu-id="eaecf-123">The second procedure shows how to add <xref:System.Security.Permissions.ReflectionPermission> with the <xref:System.Security.Permissions.ReflectionPermissionFlag.RestrictedMemberAccess?displayProperty=nameWithType> flag to a partially trusted application domain, to enable access to private data in assemblies of equal or lesser trust.</span></span>

### <a name="creating-sandboxed-application-domains"></a><span data-ttu-id="eaecf-124">Erstellen von Sandbox-Anwendungsdomänen</span><span class="sxs-lookup"><span data-stu-id="eaecf-124">Creating Sandboxed Application Domains</span></span>

<span data-ttu-id="eaecf-125">Um eine Anwendungsdomäne zu erstellen, in der Ihre Assemblys mit teilweiser Vertrauenswürdigkeit ausgeführt werden, müssen Sie den Satz der Berechtigungen, die den Assemblys erteilt werden sollen, mithilfe der <xref:System.AppDomain.CreateDomain%28System.String%2CSystem.Security.Policy.Evidence%2CSystem.AppDomainSetup%2CSystem.Security.PermissionSet%2CSystem.Security.Policy.StrongName%5B%5D%29?displayProperty=nameWithType>-Methodenüberladung angeben.</span><span class="sxs-lookup"><span data-stu-id="eaecf-125">To create an application domain in which your assemblies run with partial trust, you must specify the set of permissions to be granted to the assemblies by using the <xref:System.AppDomain.CreateDomain%28System.String%2CSystem.Security.Policy.Evidence%2CSystem.AppDomainSetup%2CSystem.Security.PermissionSet%2CSystem.Security.Policy.StrongName%5B%5D%29?displayProperty=nameWithType> method overload to create the application domain.</span></span> <span data-ttu-id="eaecf-126">Am einfachsten ist es, einen benannten Berechtigungssatz aus der Sicherheitsrichtlinie abzurufen.</span><span class="sxs-lookup"><span data-stu-id="eaecf-126">The easiest way to specify the grant set is to retrieve a named permission set from security policy.</span></span>

<span data-ttu-id="eaecf-127">Im folgenden Verfahren wird eine Sandbox-Anwendungsdomäne erstellt, die Code mit teilweiser Vertrauenswürdigkeit ausführt, um Szenarios zu testen, in denen ausgegebener Code nur auf öffentliche Member öffentlicher Typen zugreifen kann.</span><span class="sxs-lookup"><span data-stu-id="eaecf-127">The following procedure creates a sandboxed application domain that runs your code with partial trust, to test scenarios in which emitted code can access only public members of public types.</span></span> <span data-ttu-id="eaecf-128">In einem späteren Verfahren wird beschrieben, wie Sie <xref:System.Security.Permissions.ReflectionPermissionFlag.RestrictedMemberAccess> hinzufügen, um Szenarios zu testen, in denen ausgegebener Code auf nicht öffentliche Typen und Member in Assemblys zugreifen kann, denen die gleichen oder geringere Berechtigungen erteilt wurden.</span><span class="sxs-lookup"><span data-stu-id="eaecf-128">A subsequent procedure shows how to add <xref:System.Security.Permissions.ReflectionPermissionFlag.RestrictedMemberAccess>, to test scenarios in which emitted code can access nonpublic types and members in assemblies that are granted equal or lesser permissions.</span></span>

#### <a name="to-create-an-application-domain-with-partial-trust"></a><span data-ttu-id="eaecf-129">So erstellen Sie eine Anwendungsdomäne mit teilweiser Vertrauenswürdigkeit</span><span class="sxs-lookup"><span data-stu-id="eaecf-129">To create an application domain with partial trust</span></span>

1. <span data-ttu-id="eaecf-130">Erstellen Sie einen Berechtigungssatz, der den Assemblys in der Sandkastenanwendungsdomäne gewährt wird.</span><span class="sxs-lookup"><span data-stu-id="eaecf-130">Create a permission set to grant to the assemblies in the sandboxed application domain.</span></span> <span data-ttu-id="eaecf-131">In diesem Fall wird der Berechtigungssatz der Internetzone verwendet.</span><span class="sxs-lookup"><span data-stu-id="eaecf-131">In this case, the permission set of the Internet zone is used.</span></span>

    [!code-csharp[HowToEmitCodeInPartialTrust#2](../../../samples/snippets/csharp/VS_Snippets_CLR/HowToEmitCodeInPartialTrust/cs/source.cs#2)]
    [!code-vb[HowToEmitCodeInPartialTrust#2](../../../samples/snippets/visualbasic/VS_Snippets_CLR/HowToEmitCodeInPartialTrust/vb/source.vb#2)]

2. <span data-ttu-id="eaecf-132">Erstellen Sie ein <xref:System.AppDomainSetup>-Objekt, um die Anwendungsdomäne mit einem Anwendungspfad zu initialisieren.</span><span class="sxs-lookup"><span data-stu-id="eaecf-132">Create an <xref:System.AppDomainSetup> object to initialize the application domain with an application path.</span></span>

    > [!IMPORTANT]
    > <span data-ttu-id="eaecf-133">In diesem Codebeispiel wird der Einfachheit halber der aktuelle Ordner verwendet.</span><span class="sxs-lookup"><span data-stu-id="eaecf-133">For simplicity, this code example uses the current folder.</span></span> <span data-ttu-id="eaecf-134">Um Code auszuführen, der eigentlich aus dem Internet stammt, verwenden Sie einen separaten Ordner für den nicht vertrauenswürdigen Code, wie in [Vorgehensweise: Ausführen von teilweise vertrauenswürdigem Code in einem Sandkasten](../misc/how-to-run-partially-trusted-code-in-a-sandbox.md) beschrieben.</span><span class="sxs-lookup"><span data-stu-id="eaecf-134">To run code that actually comes from the Internet, use a separate folder for the untrusted code, as described in [How to: Run Partially Trusted Code in a Sandbox](../misc/how-to-run-partially-trusted-code-in-a-sandbox.md).</span></span>

    [!code-csharp[HowToEmitCodeInPartialTrust#3](../../../samples/snippets/csharp/VS_Snippets_CLR/HowToEmitCodeInPartialTrust/cs/source.cs#3)]
    [!code-vb[HowToEmitCodeInPartialTrust#3](../../../samples/snippets/visualbasic/VS_Snippets_CLR/HowToEmitCodeInPartialTrust/vb/source.vb#3)]

3. <span data-ttu-id="eaecf-135">Erstellen Sie die Anwendungsdomäne, indem Sie die Setupinformationen der Anwendungsdomäne und den Berechtigungssatz für alle Assemblys angeben, die in der Anwendungsdomäne ausgeführt werden.</span><span class="sxs-lookup"><span data-stu-id="eaecf-135">Create the application domain, specifying the application domain setup information and the grant set for all assemblies that execute in the application domain.</span></span>

    [!code-csharp[HowToEmitCodeInPartialTrust#5](../../../samples/snippets/csharp/VS_Snippets_CLR/HowToEmitCodeInPartialTrust/cs/source.cs#5)]
    [!code-vb[HowToEmitCodeInPartialTrust#5](../../../samples/snippets/visualbasic/VS_Snippets_CLR/HowToEmitCodeInPartialTrust/vb/source.vb#5)]

    <span data-ttu-id="eaecf-136">Mit dem letzten Parameter der <xref:System.AppDomain.CreateDomain%28System.String%2CSystem.Security.Policy.Evidence%2CSystem.AppDomainSetup%2CSystem.Security.PermissionSet%2CSystem.Security.Policy.StrongName%5B%5D%29?displayProperty=nameWithType>-Methodenüberladung können Sie anstelle des Berechtigungssatzes der Anwendungsdomäne eine Gruppe von Assemblys angeben, denen volle Vertrauenswürdigkeit erteilt werden soll.</span><span class="sxs-lookup"><span data-stu-id="eaecf-136">The last parameter of the <xref:System.AppDomain.CreateDomain%28System.String%2CSystem.Security.Policy.Evidence%2CSystem.AppDomainSetup%2CSystem.Security.PermissionSet%2CSystem.Security.Policy.StrongName%5B%5D%29?displayProperty=nameWithType> method overload enables you to specify a set of assemblies that are to be granted full trust, instead of the grant set of the application domain.</span></span> <span data-ttu-id="eaecf-137">Die von der Anwendung verwendeten .NET Framework-Assemblys müssen Sie nicht angeben, da diese Assemblys im globalen Assemblycache enthalten sind.</span><span class="sxs-lookup"><span data-stu-id="eaecf-137">You do not have to specify the .NET Framework assemblies that your application uses, because those assemblies are in the global assembly cache.</span></span> <span data-ttu-id="eaecf-138">Assemblys im globalen Assemblycache sind immer voll vertrauenswürdig.</span><span class="sxs-lookup"><span data-stu-id="eaecf-138">Assemblies in the global assembly cache are always fully trusted.</span></span> <span data-ttu-id="eaecf-139">Sie können diesen Parameter verwenden, um Assemblys mit starkem Namen anzugeben, die nicht im globalen Assemblycache enthalten sind.</span><span class="sxs-lookup"><span data-stu-id="eaecf-139">You can use this parameter to specify strong-named assemblies that are not in the global assembly cache.</span></span>

### <a name="adding-restrictedmemberaccess-to-sandboxed-domains"></a><span data-ttu-id="eaecf-140">Hinzufügen von eingeschränktem Memberzugriff auf Sandboxdomänen</span><span class="sxs-lookup"><span data-stu-id="eaecf-140">Adding RestrictedMemberAccess to Sandboxed Domains</span></span>

<span data-ttu-id="eaecf-141">Hostanwendungen können anonym gehosteten dynamischen Methoden Zugriff auf private Daten in Assemblys ermöglichen, die die gleiche oder eine geringere Vertrauensebene als die Assembly aufweisen, die den Code ausgibt.</span><span class="sxs-lookup"><span data-stu-id="eaecf-141">Host applications can allow anonymously hosted dynamic methods to have access to private data in assemblies that have trust levels equal to or less than the trust level of the assembly that emits the code.</span></span> <span data-ttu-id="eaecf-142">Um diese eingeschränkte Fähigkeit zum Überspringen von JIT-Sichtbarkeitsprüfungen zu ermöglichen, fügt die Hostanwendung dem Berechtigungssatz ein <xref:System.Security.Permissions.ReflectionPermission>-Objekt mit dem <xref:System.Security.Permissions.ReflectionPermissionFlag.RestrictedMemberAccess?displayProperty=nameWithType>-Flag hinzu.</span><span class="sxs-lookup"><span data-stu-id="eaecf-142">To enable this restricted ability to skip just-in-time (JIT) visibility checks, the host application adds a <xref:System.Security.Permissions.ReflectionPermission> object with the <xref:System.Security.Permissions.ReflectionPermissionFlag.RestrictedMemberAccess?displayProperty=nameWithType> (RMA) flag to the grant set.</span></span>

<span data-ttu-id="eaecf-143">Beispielsweise kann ein Host Internetanwendungen sowohl Internetberechtigungen als auch eingeschränkten Memberzugriff (RestrictedMemberAccess, RMA) erteilen, sodass eine Internetanwendung Code ausgeben kann, der auf private Daten in den eigenen Assemblys zugreift.</span><span class="sxs-lookup"><span data-stu-id="eaecf-143">For example, a host might grant Internet applications Internet permissions plus RMA, so that an Internet application can emit code that accesses private data in its own assemblies.</span></span> <span data-ttu-id="eaecf-144">Da der Zugriff auf Assemblys mit gleicher oder geringerer Vertrauenswürdigkeit beschränkt ist, kann eine Internetanwendung nicht auf Member voll vertrauenswürdiger Assemblys zugreifen, z. B. .NET Framework-Assemblys.</span><span class="sxs-lookup"><span data-stu-id="eaecf-144">Because the access is limited to assemblies of equal or lesser trust, an Internet application cannot access members of fully trusted assemblies such as .NET Framework assemblies.</span></span>

> [!NOTE]
> <span data-ttu-id="eaecf-145">Um Rechteerweiterungen zu verhindern, werden beim Erstellen anonym gehosteter dynamischer Methoden Stapelinformationen für die ausgebende Assembly einbezogen.</span><span class="sxs-lookup"><span data-stu-id="eaecf-145">To prevent elevation of privilege, stack information for the emitting assembly is included when anonymously hosted dynamic methods are constructed.</span></span> <span data-ttu-id="eaecf-146">Wenn die Methode aufgerufen wird, werden die Stapelinformationen überprüft.</span><span class="sxs-lookup"><span data-stu-id="eaecf-146">When the method is invoked, the stack information is checked.</span></span> <span data-ttu-id="eaecf-147">Daher ist eine anonym gehostete dynamische Methode, die über voll vertrauenswürdigen Code aufgerufen wird, auf die Vertrauensebene der ausgebenden Assembly beschränkt.</span><span class="sxs-lookup"><span data-stu-id="eaecf-147">Thus, an anonymously hosted dynamic method that is invoked from fully trusted code is still limited to the trust level of the emitting assembly.</span></span>

#### <a name="to-create-an-application-domain-with-partial-trust-plus-rma"></a><span data-ttu-id="eaecf-148">So erstellen Sie eine Anwendungsdomäne mit teilweiser Vertrauenswürdigkeit und eingeschränktem Memberzugriff</span><span class="sxs-lookup"><span data-stu-id="eaecf-148">To create an application domain with partial trust plus RMA</span></span>

1. <span data-ttu-id="eaecf-149">Erstellen Sie ein neues <xref:System.Security.Permissions.ReflectionPermission>-Objekt mit dem <xref:System.Security.Permissions.ReflectionPermissionFlag.RestrictedMemberAccess> (RMA)-Flag, und fügen Sie die Berechtigung mit der <xref:System.Security.PermissionSet.SetPermission%2A?displayProperty=nameWithType>-Methode dem Berechtigungssatz hinzu.</span><span class="sxs-lookup"><span data-stu-id="eaecf-149">Create a new <xref:System.Security.Permissions.ReflectionPermission> object with the <xref:System.Security.Permissions.ReflectionPermissionFlag.RestrictedMemberAccess> (RMA) flag, and use the <xref:System.Security.PermissionSet.SetPermission%2A?displayProperty=nameWithType> method to add the permission to the grant set.</span></span>

    [!code-csharp[HowToEmitCodeInPartialTrust#7](../../../samples/snippets/csharp/VS_Snippets_CLR/HowToEmitCodeInPartialTrust/cs/source.cs#7)]
    [!code-vb[HowToEmitCodeInPartialTrust#7](../../../samples/snippets/visualbasic/VS_Snippets_CLR/HowToEmitCodeInPartialTrust/vb/source.vb#7)]

    <span data-ttu-id="eaecf-150">Wenn die Berechtigung noch nicht im Berechtigungssatz enthalten ist, wird sie mit der <xref:System.Security.PermissionSet.AddPermission%2A>-Methode hinzugefügt.</span><span class="sxs-lookup"><span data-stu-id="eaecf-150">The <xref:System.Security.PermissionSet.AddPermission%2A> method adds the permission to the grant set if it is not already included.</span></span> <span data-ttu-id="eaecf-151">Wenn die Berechtigung bereits im Berechtigungssatz enthalten ist, werden die angegebenen Flags der vorhandenen Berechtigung hinzugefügt.</span><span class="sxs-lookup"><span data-stu-id="eaecf-151">If the permission is already included in the grant set, the specified flags are added to the existing permission.</span></span>

    > [!NOTE]
    > <span data-ttu-id="eaecf-152">Das Feature des eingeschränkten Memberzugriffs ist ein Feature anonym gehosteter dynamischer Methoden.</span><span class="sxs-lookup"><span data-stu-id="eaecf-152">RMA is a feature of anonymously hosted dynamic methods.</span></span> <span data-ttu-id="eaecf-153">Wenn gewöhnliche dynamische Methoden die JIT-Sichtbarkeitsüberprüfungen überspringen, erfordert der ausgegebene Code volle Vertrauenswürdigkeit.</span><span class="sxs-lookup"><span data-stu-id="eaecf-153">When ordinary dynamic methods skip JIT visibility checks, the emitted code requires full trust.</span></span>

2. <span data-ttu-id="eaecf-154">Erstellen Sie die Anwendungsdomäne, indem Sie die Setupinformationen für die Anwendungsdomäne und den Berechtigungssatz angeben.</span><span class="sxs-lookup"><span data-stu-id="eaecf-154">Create the application domain, specifying the application domain setup information and the grant set.</span></span>

    [!code-csharp[HowToEmitCodeInPartialTrust#8](../../../samples/snippets/csharp/VS_Snippets_CLR/HowToEmitCodeInPartialTrust/cs/source.cs#8)]
    [!code-vb[HowToEmitCodeInPartialTrust#8](../../../samples/snippets/visualbasic/VS_Snippets_CLR/HowToEmitCodeInPartialTrust/vb/source.vb#8)]

<a name="Running_code"></a>

## <a name="running-code-in-sandboxed-application-domains"></a><span data-ttu-id="eaecf-155">Ausführen von Code in Sandbox-Anwendungsdomänen</span><span class="sxs-lookup"><span data-stu-id="eaecf-155">Running Code in Sandboxed Application Domains</span></span>

<span data-ttu-id="eaecf-156">Im folgenden Verfahren wird beschrieben, wie Sie eine Klasse mit Methoden definieren, die in einer Anwendungsdomäne ausgeführt werden können, wie Sie eine Instanz dieser Klasse in der Domäne erstellen und wie Sie deren Methoden ausführen.</span><span class="sxs-lookup"><span data-stu-id="eaecf-156">The following procedure explains how to define a class by using methods that can be executed in an application domain, how to create an instance of the class in the domain, and how to execute its methods.</span></span>

#### <a name="to-define-and-execute-a-method-in-an-application-domain"></a><span data-ttu-id="eaecf-157">So definieren Sie eine Methode in einer Anwendungsdomäne und führen sie aus</span><span class="sxs-lookup"><span data-stu-id="eaecf-157">To define and execute a method in an application domain</span></span>

1. <span data-ttu-id="eaecf-158">Definieren Sie eine Klasse, die sich von <xref:System.MarshalByRefObject> ableitet.</span><span class="sxs-lookup"><span data-stu-id="eaecf-158">Define a class that derives from <xref:System.MarshalByRefObject>.</span></span> <span data-ttu-id="eaecf-159">Auf diese Weise können Sie Instanzen der Klasse in anderen Anwendungsdomänen erstellen und Methoden über die Grenzen der Anwendungsdomäne hinweg aufrufen.</span><span class="sxs-lookup"><span data-stu-id="eaecf-159">This enables you to create instances of the class in other application domains and to make method calls across application domain boundaries.</span></span> <span data-ttu-id="eaecf-160">Die Klasse in diesem Beispiel hat den Namen `Worker`.</span><span class="sxs-lookup"><span data-stu-id="eaecf-160">The class in this example is named `Worker`.</span></span>

    [!code-csharp[HowToEmitCodeInPartialTrust#10](../../../samples/snippets/csharp/VS_Snippets_CLR/HowToEmitCodeInPartialTrust/cs/source.cs#10)]
    [!code-vb[HowToEmitCodeInPartialTrust#10](../../../samples/snippets/visualbasic/VS_Snippets_CLR/HowToEmitCodeInPartialTrust/vb/source.vb#10)]

2. <span data-ttu-id="eaecf-161">Definieren Sie eine öffentliche Methode, die den Code enthält, den Sie ausführen möchten.</span><span class="sxs-lookup"><span data-stu-id="eaecf-161">Define a public method that contains the code you want to execute.</span></span> <span data-ttu-id="eaecf-162">In diesem Beispiel gibt der Code eine einfache dynamische Methode aus, erstellt einen Delegaten zum Ausführen der Methode und ruft den Delegaten auf.</span><span class="sxs-lookup"><span data-stu-id="eaecf-162">In this example, the code emits a simple dynamic method, creates a delegate to execute the method, and invokes the delegate.</span></span>

    [!code-csharp[HowToEmitCodeInPartialTrust#11](../../../samples/snippets/csharp/VS_Snippets_CLR/HowToEmitCodeInPartialTrust/cs/source.cs#11)]
    [!code-vb[HowToEmitCodeInPartialTrust#11](../../../samples/snippets/visualbasic/VS_Snippets_CLR/HowToEmitCodeInPartialTrust/vb/source.vb#11)]

3. <span data-ttu-id="eaecf-163">Rufen Sie im Hauptprogramm den Anzeigenamen der Assembly ab.</span><span class="sxs-lookup"><span data-stu-id="eaecf-163">In your main program, get the display name of your assembly.</span></span> <span data-ttu-id="eaecf-164">Dieser Name wird verwendet, wenn Sie Instanzen der `Worker`-Klasse in der Sandbox-Anwendungsdomäne erstellen.</span><span class="sxs-lookup"><span data-stu-id="eaecf-164">This name is used when you create instances of the `Worker` class in the sandboxed application domain.</span></span>

    [!code-csharp[HowToEmitCodeInPartialTrust#14](../../../samples/snippets/csharp/VS_Snippets_CLR/HowToEmitCodeInPartialTrust/cs/source.cs#14)]
    [!code-vb[HowToEmitCodeInPartialTrust#14](../../../samples/snippets/visualbasic/VS_Snippets_CLR/HowToEmitCodeInPartialTrust/vb/source.vb#14)]

4. <span data-ttu-id="eaecf-165">Erstellen Sie im Hauptprogramm eine Sandbox-Anwendungsdomäne, wie in der [ersten Prozedur](#Setting_up) dieser exemplarischen Vorgehensweise beschrieben.</span><span class="sxs-lookup"><span data-stu-id="eaecf-165">In your main program, create a sandboxed application domain, as described in [the first procedure](#Setting_up) in this walkthrough.</span></span> <span data-ttu-id="eaecf-166">Sie müssen dem `Internet`-Berechtigungssatz keine Berechtigungen hinzufügen, da die `SimpleEmitDemo`-Methode nur öffentliche Methoden verwendet.</span><span class="sxs-lookup"><span data-stu-id="eaecf-166">You do not have to add any permissions to the `Internet` permission set, because the `SimpleEmitDemo` method uses only public methods.</span></span>

5. <span data-ttu-id="eaecf-167">Erstellen Sie im Hauptprogramm eine Instanz der `Worker`-Klasse in der Sandbox-Anwendungsdomäne.</span><span class="sxs-lookup"><span data-stu-id="eaecf-167">In your main program, create an instance of the `Worker` class in the sandboxed application domain.</span></span>

    [!code-csharp[HowToEmitCodeInPartialTrust#12](../../../samples/snippets/csharp/VS_Snippets_CLR/HowToEmitCodeInPartialTrust/cs/source.cs#12)]
    [!code-vb[HowToEmitCodeInPartialTrust#12](../../../samples/snippets/visualbasic/VS_Snippets_CLR/HowToEmitCodeInPartialTrust/vb/source.vb#12)]

    <span data-ttu-id="eaecf-168">Die <xref:System.AppDomain.CreateInstanceAndUnwrap%2A>-Methode erstellt das Objekt in der Zielanwendungsdomäne und gibt einen Proxy zurück, der zum Aufrufen der Eigenschaften und Methoden des Objekts verwendet werden kann.</span><span class="sxs-lookup"><span data-stu-id="eaecf-168">The <xref:System.AppDomain.CreateInstanceAndUnwrap%2A> method creates the object in the target application domain and returns a proxy that can be used to call the properties and methods of the object.</span></span>

    > [!NOTE]
    > <span data-ttu-id="eaecf-169">Wenn Sie diesen Code in Visual Studio verwenden, müssen Sie den Namen der Klasse ändern, sodass der Namespace enthalten ist.</span><span class="sxs-lookup"><span data-stu-id="eaecf-169">If you use this code in Visual Studio, you must change the name of the class to include the namespace.</span></span> <span data-ttu-id="eaecf-170">Standardmäßig ist der Namespace der Name des Projekts.</span><span class="sxs-lookup"><span data-stu-id="eaecf-170">By default, the namespace is the name of the project.</span></span> <span data-ttu-id="eaecf-171">Wenn das Projekt z. B. "PartialTrust" heißt, muss der Klassenname "PartialTrust.Worker" lauten.</span><span class="sxs-lookup"><span data-stu-id="eaecf-171">For example, if the project is "PartialTrust", the class name must be "PartialTrust.Worker".</span></span>

6. <span data-ttu-id="eaecf-172">Fügen Sie Code zum Aufrufen der `SimpleEmitDemo`-Methode hinzu.</span><span class="sxs-lookup"><span data-stu-id="eaecf-172">Add code to call the `SimpleEmitDemo` method.</span></span> <span data-ttu-id="eaecf-173">Der Aufruf wird über die Grenze der Anwendungsdomäne hinweg gemarshallt, und der Code wird in der Sandbox-Anwendungsdomäne ausgeführt.</span><span class="sxs-lookup"><span data-stu-id="eaecf-173">The call is marshaled across the application domain boundary, and the code is executed in the sandboxed application domain.</span></span>

    [!code-csharp[HowToEmitCodeInPartialTrust#13](../../../samples/snippets/csharp/VS_Snippets_CLR/HowToEmitCodeInPartialTrust/cs/source.cs#13)]
    [!code-vb[HowToEmitCodeInPartialTrust#13](../../../samples/snippets/visualbasic/VS_Snippets_CLR/HowToEmitCodeInPartialTrust/vb/source.vb#13)]

<a name="Using_methods"></a>

## <a name="using-anonymously-hosted-dynamic-methods"></a><span data-ttu-id="eaecf-174">Verwenden von anonym gehosteten dynamischen Methoden</span><span class="sxs-lookup"><span data-stu-id="eaecf-174">Using Anonymously Hosted Dynamic Methods</span></span>

<span data-ttu-id="eaecf-175">Anonym gehostete dynamische Methoden werden einer transparenten Assembly zugeordnet, die vom System bereitgestellt wird.</span><span class="sxs-lookup"><span data-stu-id="eaecf-175">Anonymously hosted dynamic methods are associated with a transparent assembly that is provided by the system.</span></span> <span data-ttu-id="eaecf-176">Daher ist der Code, den sie enthalten, transparent.</span><span class="sxs-lookup"><span data-stu-id="eaecf-176">Therefore, the code they contain is transparent.</span></span> <span data-ttu-id="eaecf-177">Gewöhnliche dynamische Methoden müssen andererseits einem vorhandenen Modul (das entweder direkt angegeben oder von einem zugeordneten Typ abgeleitet wird) zugeordnet sein und übernehmen ihre Sicherheitsstufe von diesem Modul.</span><span class="sxs-lookup"><span data-stu-id="eaecf-177">Ordinary dynamic methods, on the other hand, must be associated with an existing module (whether directly specified or inferred from an associated type), and take their security level from that module.</span></span>

> [!NOTE]
> <span data-ttu-id="eaecf-178">Die einzige Möglichkeit, der Assembly, die anonymes Hosting bereitstellt, eine dynamische Methode zuzuordnen, ist die Verwendung der in den folgenden Verfahren beschriebenen Konstruktoren.</span><span class="sxs-lookup"><span data-stu-id="eaecf-178">The only way to associate a dynamic method with the assembly that provides anonymous hosting is to use the constructors that are described in the following procedure.</span></span> <span data-ttu-id="eaecf-179">Es ist nicht möglich, ein Modul in der anonymen Hostingassembly explizit anzugeben.</span><span class="sxs-lookup"><span data-stu-id="eaecf-179">You cannot explicitly specify a module in the anonymous hosting assembly.</span></span>

<span data-ttu-id="eaecf-180">Normale dynamische Methoden verfügen über Zugriff auf die internen Member des Moduls, dem sie zugeordnet sind, oder auf die privaten Member des Typs, dem sie zugeordnet sind.</span><span class="sxs-lookup"><span data-stu-id="eaecf-180">Ordinary dynamic methods have access to the internal members of the module they are associated with, or to the private members of the type they are associated with.</span></span> <span data-ttu-id="eaecf-181">Da anonym gehostete dynamische Methoden von anderem Code isoliert sind, verfügen sie über keinen Zugriff auf private Daten.</span><span class="sxs-lookup"><span data-stu-id="eaecf-181">Because anonymously hosted dynamic methods are isolated from other code, they do not have access to private data.</span></span> <span data-ttu-id="eaecf-182">Sie besitzen jedoch die eingeschränkte Fähigkeit, JIT-Sichtbarkeitsprüfungen zu überspringen, um Zugriff auf private Daten zu erhalten.</span><span class="sxs-lookup"><span data-stu-id="eaecf-182">However, they do have a restricted ability to skip JIT visibility checks to gain access to private data.</span></span> <span data-ttu-id="eaecf-183">Diese Möglichkeit ist auf Assemblys beschränkt, die die gleiche oder eine geringere Vertrauensebene aufweisen als die Assembly, die den Code ausgibt.</span><span class="sxs-lookup"><span data-stu-id="eaecf-183">This ability is limited to assemblies that have trust levels equal to or less than the trust level of the assembly that emits the code.</span></span>

<span data-ttu-id="eaecf-184">Um Rechteerweiterungen zu verhindern, werden beim Erstellen anonym gehosteter dynamischer Methoden Stapelinformationen für die ausgebende Assembly einbezogen.</span><span class="sxs-lookup"><span data-stu-id="eaecf-184">To prevent elevation of privilege, stack information for the emitting assembly is included when anonymously hosted dynamic methods are constructed.</span></span> <span data-ttu-id="eaecf-185">Wenn die Methode aufgerufen wird, werden die Stapelinformationen überprüft.</span><span class="sxs-lookup"><span data-stu-id="eaecf-185">When the method is invoked, the stack information is checked.</span></span> <span data-ttu-id="eaecf-186">Eine anonym gehostete dynamische Methode, die über voll vertrauenswürdigen Code aufgerufen wird, ist auf die Vertrauensebene der ausgebenden Assembly beschränkt.</span><span class="sxs-lookup"><span data-stu-id="eaecf-186">An anonymously hosted dynamic method that is invoked from fully trusted code is still limited to the trust level of the assembly that emitted it.</span></span>

#### <a name="to-use-anonymously-hosted-dynamic-methods"></a><span data-ttu-id="eaecf-187">So verwenden Sie anonym gehostete dynamische Methoden</span><span class="sxs-lookup"><span data-stu-id="eaecf-187">To use anonymously hosted dynamic methods</span></span>

- <span data-ttu-id="eaecf-188">Erstellen Sie eine anonym gehostete dynamische Methode, indem Sie einen Konstruktor verwenden, der kein zugeordnetes Modul und keinen zugeordneten Typ angibt.</span><span class="sxs-lookup"><span data-stu-id="eaecf-188">Create an anonymously hosted dynamic method by using a constructor that does not specify an associated module or type.</span></span>

  [!code-csharp[HowToEmitCodeInPartialTrust#15](../../../samples/snippets/csharp/VS_Snippets_CLR/HowToEmitCodeInPartialTrust/cs/source.cs#15)]
  [!code-vb[HowToEmitCodeInPartialTrust#15](../../../samples/snippets/visualbasic/VS_Snippets_CLR/HowToEmitCodeInPartialTrust/vb/source.vb#15)]

  <span data-ttu-id="eaecf-189">Wenn eine anonym gehostete dynamische Methode nur öffentliche Typen und Methoden verwendet, erfordert sie keinen eingeschränkten Memberzugriff und muss keine JIT-Sichtbarkeitsprüfungen überspringen.</span><span class="sxs-lookup"><span data-stu-id="eaecf-189">If an anonymously hosted dynamic method uses only public types and methods, it does not require restricted member access and does not have to skip JIT visibility checks.</span></span>

  <span data-ttu-id="eaecf-190">Zur Ausgabe einer dynamischen Methode sind keine speziellen Berechtigungen erforderlich. Der ausgegebene Code erfordert jedoch die Berechtigungen, die von den verwendeten Typen und Methoden verlangt werden.</span><span class="sxs-lookup"><span data-stu-id="eaecf-190">No special permissions are required to emit a dynamic method, but the emitted code requires the permissions that are demanded by the types and methods it uses.</span></span> <span data-ttu-id="eaecf-191">Wenn der ausgegebene Code z. B. eine Methode aufruft, die auf eine Datei zugreift, erfordert er <xref:System.Security.Permissions.FileIOPermission>.</span><span class="sxs-lookup"><span data-stu-id="eaecf-191">For example, if the emitted code calls a method that accesses a file, it requires <xref:System.Security.Permissions.FileIOPermission>.</span></span> <span data-ttu-id="eaecf-192">Wenn diese Berechtigung in der Vertrauensebene nicht enthalten ist, wird eine Sicherheitsausnahme ausgelöst, sobald der ausgegebene Code ausgeführt wird.</span><span class="sxs-lookup"><span data-stu-id="eaecf-192">If the trust level does not include that permission, a security exception is thrown when the emitted code is executed.</span></span> <span data-ttu-id="eaecf-193">Der hier dargestellte Code gibt eine dynamische Methode aus, die nur die <xref:System.Console.WriteLine%2A?displayProperty=nameWithType>-Methode verwendet.</span><span class="sxs-lookup"><span data-stu-id="eaecf-193">The code shown here emits a dynamic method that uses only the <xref:System.Console.WriteLine%2A?displayProperty=nameWithType> method.</span></span> <span data-ttu-id="eaecf-194">Daher kann der Code über teilweise vertrauenswürdige Speicherorte ausgeführt werden.</span><span class="sxs-lookup"><span data-stu-id="eaecf-194">Therefore, the code can be executed from partially trusted locations.</span></span>

- <span data-ttu-id="eaecf-195">Alternativ können Sie eine anonym gehostete dynamische Methode mit eingeschränkter Fähigkeit zum Überspringen von JIT-Sichtbarkeitsprüfungen erstellen, indem Sie den <xref:System.Reflection.Emit.DynamicMethod.%23ctor%28System.String%2CSystem.Type%2CSystem.Type%5B%5D%2CSystem.Boolean%29>-Konstruktor verwenden und `true` für den `restrictedSkipVisibility`-Parameter angeben.</span><span class="sxs-lookup"><span data-stu-id="eaecf-195">Alternatively, create an anonymously hosted dynamic method with restricted ability to skip JIT visibility checks, by using the <xref:System.Reflection.Emit.DynamicMethod.%23ctor%28System.String%2CSystem.Type%2CSystem.Type%5B%5D%2CSystem.Boolean%29> constructor and specifying `true` for the `restrictedSkipVisibility` parameter.</span></span>

  [!code-csharp[HowToEmitCodeInPartialTrust#16](../../../samples/snippets/csharp/VS_Snippets_CLR/HowToEmitCodeInPartialTrust/cs/source.cs#16)]
  [!code-vb[HowToEmitCodeInPartialTrust#16](../../../samples/snippets/visualbasic/VS_Snippets_CLR/HowToEmitCodeInPartialTrust/vb/source.vb#16)]

  <span data-ttu-id="eaecf-196">Die Einschränkung besteht darin, dass die anonym gehostete dynamische Methode nur auf private Daten in Assemblys zugreifen kann, die die gleiche oder eine geringere Vertrauensebene als die ausgebende Assembly aufweisen.</span><span class="sxs-lookup"><span data-stu-id="eaecf-196">The restriction is that the anonymously hosted dynamic method can access private data only in assemblies with trust levels equal to or less than the trust level of the emitting assembly.</span></span> <span data-ttu-id="eaecf-197">Wenn die dynamische Methode z. B. mit Internet-Vertrauenswürdigkeit ausgeführt wird, kann sie auf private Daten in Assemblys zugreifen, die ebenfalls mit Internet-Vertrauenswürdigkeit ausgeführt werden, aber nicht auf private Daten in .NET Framework-Assemblys.</span><span class="sxs-lookup"><span data-stu-id="eaecf-197">For example, if the dynamic method is executing with Internet trust, it can access private data in other assemblies that are also executing with Internet trust, but it cannot access private data of .NET Framework assemblies.</span></span> <span data-ttu-id="eaecf-198">.NET Framework-Assemblys werden im globalen Assemblycache installiert und sind immer voll vertrauenswürdig.</span><span class="sxs-lookup"><span data-stu-id="eaecf-198">.NET Framework assemblies are installed in the global assembly cache and are always fully trusted.</span></span>

  <span data-ttu-id="eaecf-199">Anonym gehostete dynamische Methoden können diese eingeschränkte Fähigkeit zum Überspringen von JIT-Sichtbarkeitsprüfungen nur verwenden, wenn die Hostanwendung <xref:System.Security.Permissions.ReflectionPermission> mit dem <xref:System.Security.Permissions.ReflectionPermissionFlag.RestrictedMemberAccess?displayProperty=nameWithType>-Flag erteilt.</span><span class="sxs-lookup"><span data-stu-id="eaecf-199">Anonymously hosted dynamic methods can use this restricted ability to skip JIT visibility checks only if the host application grants <xref:System.Security.Permissions.ReflectionPermission> with the <xref:System.Security.Permissions.ReflectionPermissionFlag.RestrictedMemberAccess?displayProperty=nameWithType> flag.</span></span> <span data-ttu-id="eaecf-200">Diese Berechtigung wird angefordert, wenn die Methode aufgerufen wird.</span><span class="sxs-lookup"><span data-stu-id="eaecf-200">The demand for this permission is made when the method is invoked.</span></span>

  > [!NOTE]
  > <span data-ttu-id="eaecf-201">Beim Erstellen der dynamischen Methode werden Aufruflisteninformationen für die ausgebende Assembly einbezogen.</span><span class="sxs-lookup"><span data-stu-id="eaecf-201">Call stack information for the emitting assembly is included when the dynamic method is constructed.</span></span> <span data-ttu-id="eaecf-202">Daher bezieht sich die Anforderung auf die Berechtigungen der ausgebenden Assembly und nicht der Assembly, die die Methode aufruft.</span><span class="sxs-lookup"><span data-stu-id="eaecf-202">Therefore, the demand is made against the permissions of the emitting assembly instead of the assembly that invokes the method.</span></span> <span data-ttu-id="eaecf-203">Somit wird verhindert, dass der ausgegebene Code mit erweiterten Berechtigungen ausgeführt wird.</span><span class="sxs-lookup"><span data-stu-id="eaecf-203">This prevents the emitted code from being executed with elevated permissions.</span></span>

  <span data-ttu-id="eaecf-204">Das [vollständige Codebeispiel](#Example) am Ende dieser exemplarischen Vorgehensweise veranschaulicht die Verwendung und die Einschränkungen des eingeschränkten Memberzugriffs.</span><span class="sxs-lookup"><span data-stu-id="eaecf-204">The [complete code example](#Example) at the end of this walkthrough demonstrates the use and limitations of restricted member access.</span></span> <span data-ttu-id="eaecf-205">Die dort verwendete `Worker`-Klasse beinhaltet eine Methode, die anonym gehostete dynamische Methoden mit oder ohne eingeschränkte Fähigkeit zum Überspringen von Sichtbarkeitsprüfungen erstellen kann. Das Beispiel zeigt das Ergebnis der Ausführung dieser Methode in Anwendungsdomänen mit verschiedenen Vertrauensebenen.</span><span class="sxs-lookup"><span data-stu-id="eaecf-205">Its `Worker` class includes a method that can create anonymously hosted dynamic methods with or without the restricted ability to skip visibility checks, and the example shows the result of executing this method in application domains that have different trust levels.</span></span>

  > [!NOTE]
  > <span data-ttu-id="eaecf-206">Die eingeschränkte Fähigkeit zum Überspringen von Sichtbarkeitsprüfungen ist ein Feature anonym gehosteter dynamischer Methoden.</span><span class="sxs-lookup"><span data-stu-id="eaecf-206">The restricted ability to skip visibility checks is a feature of anonymously hosted dynamic methods.</span></span> <span data-ttu-id="eaecf-207">Wenn gewöhnliche dynamische Methoden die JIT-Sichtbarkeitsprüfungen überspringen, muss ihnen volle Vertrauenswürdigkeit gewährt werden.</span><span class="sxs-lookup"><span data-stu-id="eaecf-207">When ordinary dynamic methods skip JIT visibility checks, they must be granted full trust.</span></span>

<a name="Example"></a>

## <a name="example"></a><span data-ttu-id="eaecf-208">Beispiel</span><span class="sxs-lookup"><span data-stu-id="eaecf-208">Example</span></span>

### <a name="description"></a><span data-ttu-id="eaecf-209">Beschreibung</span><span class="sxs-lookup"><span data-stu-id="eaecf-209">Description</span></span>

<span data-ttu-id="eaecf-210">Das folgende Codebeispiel veranschaulicht die Verwendung des <xref:System.Security.Permissions.ReflectionPermissionFlag.RestrictedMemberAccess>-Flags, um anonym gehosteten dynamischen Methoden das Überspringen von JIT-Sichtbarkeitsprüfungen zu ermöglichen, wenn der Zielmember die gleiche oder eine geringere Vertrauensebene aufweist als die Assembly, die den Code ausgibt.</span><span class="sxs-lookup"><span data-stu-id="eaecf-210">The following code example demonstrates the use of the <xref:System.Security.Permissions.ReflectionPermissionFlag.RestrictedMemberAccess> flag to allow anonymously hosted dynamic methods to skip JIT visibility checks, but only when the target member is at an equal or lower level of trust than the assembly that emits the code.</span></span>

<span data-ttu-id="eaecf-211">Im Beispiel wird eine `Worker`-Klasse definiert, die über die Grenzen der Anwendungsdomäne hinweg gemarshallt werden kann.</span><span class="sxs-lookup"><span data-stu-id="eaecf-211">The example defines a `Worker` class that can be marshaled across application domain boundaries.</span></span> <span data-ttu-id="eaecf-212">Die Klasse verfügt über zwei `AccessPrivateMethod`-Methodenüberladungen, die dynamische Methoden ausgeben und ausführen.</span><span class="sxs-lookup"><span data-stu-id="eaecf-212">The class has two `AccessPrivateMethod` method overloads that emit and execute dynamic methods.</span></span> <span data-ttu-id="eaecf-213">Die erste Überladung gibt eine dynamische Methode (mit oder ohne JIT-Sichtbarkeitsprüfungen) aus, die die private `PrivateMethod`-Methode der `Worker`-Klasse aufruft.</span><span class="sxs-lookup"><span data-stu-id="eaecf-213">The first overload emits a dynamic method that calls the private `PrivateMethod` method of the `Worker` class, and it can emit the dynamic method with or without JIT visibility checks.</span></span> <span data-ttu-id="eaecf-214">Die zweite Überladung gibt eine dynamische Methode aus, die auf eine `internal`-Eigenschaft (`Friend`-Eigenschaft in Visual Basic) der <xref:System.String>-Klasse zugreift.</span><span class="sxs-lookup"><span data-stu-id="eaecf-214">The second overload emits a dynamic method that accesses an `internal` property (`Friend` property in Visual Basic) of the <xref:System.String> class.</span></span>

<span data-ttu-id="eaecf-215">In dem Beispiel wird mit einer Hilfsmethode ein Berechtigungssatz erstellt, der auf die `Internet`-Berechtigungen begrenzt ist. Anschließend wird eine Anwendungsdomäne erstellt, wobei mit der <xref:System.AppDomain.CreateDomain%28System.String%2CSystem.Security.Policy.Evidence%2CSystem.AppDomainSetup%2CSystem.Security.PermissionSet%2CSystem.Security.Policy.StrongName%5B%5D%29?displayProperty=nameWithType>-Methodenüberladung angegeben wird, dass der gesamte Code, der in der Domäne ausgeführt wird, diesen Berechtigungssatz verwendet.</span><span class="sxs-lookup"><span data-stu-id="eaecf-215">The example uses a helper method to create a grant set limited to `Internet` permissions, and then creates an application domain, using the <xref:System.AppDomain.CreateDomain%28System.String%2CSystem.Security.Policy.Evidence%2CSystem.AppDomainSetup%2CSystem.Security.PermissionSet%2CSystem.Security.Policy.StrongName%5B%5D%29?displayProperty=nameWithType> method overload to specify that all code that executes in the domain uses this grant set.</span></span> <span data-ttu-id="eaecf-216">Außerdem wird eine Instanz der `Worker`-Klasse in der Anwendungsdomäne erstellt und die `AccessPrivateMethod`-Methode zweimal ausgeführt.</span><span class="sxs-lookup"><span data-stu-id="eaecf-216">The example creates an instance of the `Worker` class in the application domain, and executes the `AccessPrivateMethod` method two times.</span></span>

- <span data-ttu-id="eaecf-217">Bei der ersten Ausführung der `AccessPrivateMethod`-Methode werden JIT-Sichtbarkeitsprüfungen erzwungen.</span><span class="sxs-lookup"><span data-stu-id="eaecf-217">The first time the `AccessPrivateMethod` method is executed, JIT visibility checks are enforced.</span></span> <span data-ttu-id="eaecf-218">Die dynamische Methode schlägt fehl, wenn sie aufgerufen wird, da sie durch JIT-Sichtbarkeitsprüfungen daran gehindert wird, auf die private Methode zuzugreifen.</span><span class="sxs-lookup"><span data-stu-id="eaecf-218">The dynamic method fails when it is invoked, because JIT visibility checks prevent it from accessing the private method.</span></span>

- <span data-ttu-id="eaecf-219">Bei der zweiten Ausführung der `AccessPrivateMethod`-Methode werden JIT-Sichtbarkeitsprüfungen übersprungen.</span><span class="sxs-lookup"><span data-stu-id="eaecf-219">The second time the `AccessPrivateMethod` method is executed, JIT visibility checks are skipped.</span></span> <span data-ttu-id="eaecf-220">Die dynamische Methode schlägt fehl, wenn sie kompiliert wird, da der `Internet`-Berechtigungssatz keine ausreichenden Berechtigungen zum Überspringen von Sichtbarkeitsprüfungen bereitstellt.</span><span class="sxs-lookup"><span data-stu-id="eaecf-220">The dynamic method fails when it is compiled, because the `Internet` grant set does not grant sufficient permissions to skip visibility checks.</span></span>

<span data-ttu-id="eaecf-221">In diesem Beispiel wird dem Berechtigungssatz <xref:System.Security.Permissions.ReflectionPermission> mit <xref:System.Security.Permissions.ReflectionPermissionFlag.RestrictedMemberAccess?displayProperty=nameWithType> hinzugefügt.</span><span class="sxs-lookup"><span data-stu-id="eaecf-221">The example adds <xref:System.Security.Permissions.ReflectionPermission> with <xref:System.Security.Permissions.ReflectionPermissionFlag.RestrictedMemberAccess?displayProperty=nameWithType> to the grant set.</span></span> <span data-ttu-id="eaecf-222">Anschließend wird eine zweite Domäne erstellt, wobei dem gesamten Code, der in der Domäne ausgeführt wird, die Berechtigungen im neuen Berechtigungssatz erteilt werden.</span><span class="sxs-lookup"><span data-stu-id="eaecf-222">The example then creates a second domain, specifying that all code that executes in the domain is granted the permissions in the new grant set.</span></span> <span data-ttu-id="eaecf-223">Zusätzlich wird eine Instanz der `Worker`-Klasse in der neuen Anwendungsdomäne erstellt, und es werden beide Überladungen der `AccessPrivateMethod`-Methode ausgeführt.</span><span class="sxs-lookup"><span data-stu-id="eaecf-223">The example creates an instance of the `Worker` class in the new application domain, and executes both overloads of the `AccessPrivateMethod` method.</span></span>

- <span data-ttu-id="eaecf-224">Die erste Überladung der `AccessPrivateMethod`-Methode wird ausgeführt, und JIT-Sichtbarkeitsprüfungen werden übersprungen.</span><span class="sxs-lookup"><span data-stu-id="eaecf-224">The first overload of the `AccessPrivateMethod` method is executed, and JIT visibility checks are skipped.</span></span> <span data-ttu-id="eaecf-225">Die dynamische Methode wird erfolgreich kompiliert und ausgeführt, da die Assembly, die den Code ausgibt, mit der Assembly identisch ist, die die private Methode enthält.</span><span class="sxs-lookup"><span data-stu-id="eaecf-225">The dynamic method compiles and executes successfully, because the assembly that emits the code is the same as the assembly that contains the private method.</span></span> <span data-ttu-id="eaecf-226">Daher sind die Vertrauensebenen gleich.</span><span class="sxs-lookup"><span data-stu-id="eaecf-226">Therefore, the trust levels are equal.</span></span> <span data-ttu-id="eaecf-227">Wenn die Anwendung, die die `Worker`-Klasse enthält, über mehrere Assemblys verfügen würde, wäre der gleiche Prozess für jede dieser Assemblys erfolgreich, da sie alle die gleiche Vertrauensebene aufweisen würden.</span><span class="sxs-lookup"><span data-stu-id="eaecf-227">If the application that contains the `Worker` class had several assemblies, the same process would succeed for any one of those assemblies, because they would all be at the same trust level.</span></span>

- <span data-ttu-id="eaecf-228">Die zweite Überladung der `AccessPrivateMethod`-Methode wird ausgeführt, und JIT-Sichtbarkeitsprüfungen werden erneut übersprungen.</span><span class="sxs-lookup"><span data-stu-id="eaecf-228">The second overload of the `AccessPrivateMethod` method is executed, and again JIT visibility checks are skipped.</span></span> <span data-ttu-id="eaecf-229">Dieses Mal schlägt die dynamische Methode beim Kompilieren fehl, da sie versucht, auf die `internal``FirstChar`-Eigenschaft der <xref:System.String>-Klasse zuzugreifen.</span><span class="sxs-lookup"><span data-stu-id="eaecf-229">This time the dynamic method fails when it is compiled, because it tries to access the `internal` `FirstChar` property of the <xref:System.String> class.</span></span> <span data-ttu-id="eaecf-230">Die Assembly, die die <xref:System.String>-Klasse enthält, ist voll vertrauenswürdig.</span><span class="sxs-lookup"><span data-stu-id="eaecf-230">The assembly that contains the <xref:System.String> class is fully trusted.</span></span> <span data-ttu-id="eaecf-231">Somit weist sie eine höhere Vertrauensebene auf als die Assembly, die den Code ausgibt.</span><span class="sxs-lookup"><span data-stu-id="eaecf-231">Therefore, it is at a higher level of trust than the assembly that emits the code.</span></span>

<span data-ttu-id="eaecf-232">Dieser Vergleich zeigt, wie teilweise vertrauenswürdiger Code durch <xref:System.Security.Permissions.ReflectionPermissionFlag.RestrictedMemberAccess?displayProperty=nameWithType> Sichtbarkeitsprüfungen für anderen teilweise vertrauenswürdigen Code überspringen kann, ohne die Sicherheit von vertrauenswürdigem Code zu gefährden.</span><span class="sxs-lookup"><span data-stu-id="eaecf-232">This comparison shows how <xref:System.Security.Permissions.ReflectionPermissionFlag.RestrictedMemberAccess?displayProperty=nameWithType> enables partially trusted code to skip visibility checks for other partially trusted code without compromising the security of trusted code.</span></span>

### <a name="code"></a><span data-ttu-id="eaecf-233">Code</span><span class="sxs-lookup"><span data-stu-id="eaecf-233">Code</span></span>

[!code-csharp[HowToEmitCodeInPartialTrust#1](../../../samples/snippets/csharp/VS_Snippets_CLR/HowToEmitCodeInPartialTrust/cs/source.cs#1)]
[!code-vb[HowToEmitCodeInPartialTrust#1](../../../samples/snippets/visualbasic/VS_Snippets_CLR/HowToEmitCodeInPartialTrust/vb/source.vb#1)]

## <a name="compiling-the-code"></a><span data-ttu-id="eaecf-234">Kompilieren des Codes</span><span class="sxs-lookup"><span data-stu-id="eaecf-234">Compiling the Code</span></span>

- <span data-ttu-id="eaecf-235">Wenn Sie dieses Codebeispiel in Visual Studio verwenden, müssen Sie den Namespace in den Namen der Klasse einbeziehen, wenn Sie diese an die <xref:System.AppDomain.CreateInstanceAndUnwrap%2A>-Methode übergeben.</span><span class="sxs-lookup"><span data-stu-id="eaecf-235">If you build this code example in Visual Studio, you must change the name of the class to include the namespace when you pass it to the <xref:System.AppDomain.CreateInstanceAndUnwrap%2A> method.</span></span> <span data-ttu-id="eaecf-236">Standardmäßig ist der Namespace der Name des Projekts.</span><span class="sxs-lookup"><span data-stu-id="eaecf-236">By default, the namespace is the name of the project.</span></span> <span data-ttu-id="eaecf-237">Wenn das Projekt z. B. "PartialTrust" heißt, muss der Klassenname "PartialTrust.Worker" lauten.</span><span class="sxs-lookup"><span data-stu-id="eaecf-237">For example, if the project is "PartialTrust", the class name must be "PartialTrust.Worker".</span></span>

## <a name="see-also"></a><span data-ttu-id="eaecf-238">Siehe auch</span><span class="sxs-lookup"><span data-stu-id="eaecf-238">See also</span></span>

- [<span data-ttu-id="eaecf-239">Sicherheitsaspekte bei der Reflektionsausgabe</span><span class="sxs-lookup"><span data-stu-id="eaecf-239">Security Issues in Reflection Emit</span></span>](security-issues-in-reflection-emit.md)
- [<span data-ttu-id="eaecf-240">How to: Ausführen von teilweise vertrauenswürdigem Code in einem Sandkasten</span><span class="sxs-lookup"><span data-stu-id="eaecf-240">How to: Run Partially Trusted Code in a Sandbox</span></span>](../misc/how-to-run-partially-trusted-code-in-a-sandbox.md)
