---
title: 'Vorgehensweise: Schreiben einer Parallel.ForEach-Schleife mit partitionslokalen Variablen'
ms.date: 06/26/2018
ms.technology: dotnet-standard
dev_langs:
- csharp
- vb
helpviewer_keywords:
- parallel foreach loop, how to use local state
ms.assetid: 24b10041-b30b-45cb-aa65-66cf568ca76d
ms.openlocfilehash: eff176f7c3ae5cae4c450047214d8e9e20a6e66d
ms.sourcegitcommit: 33deec3e814238fb18a49b2a7e89278e27888291
ms.translationtype: HT
ms.contentlocale: de-DE
ms.lasthandoff: 06/02/2020
ms.locfileid: "84290745"
---
# <a name="how-to-write-a-parallelforeach-loop-with-partition-local-variables"></a><span data-ttu-id="08275-102">Vorgehensweise: Schreiben einer Parallel.ForEach-Schleife mit partitionslokalen Variablen</span><span class="sxs-lookup"><span data-stu-id="08275-102">How to: Write a Parallel.ForEach loop with partition-local variables</span></span>

<span data-ttu-id="08275-103">Im folgenden Beispiel wird veranschaulicht, wie eine <xref:System.Threading.Tasks.Parallel.ForEach%2A>-Methode geschrieben wird, für die partitionslokale Variablen verwendet werden.</span><span class="sxs-lookup"><span data-stu-id="08275-103">The following example shows how to write a <xref:System.Threading.Tasks.Parallel.ForEach%2A> method that uses partition-local variables.</span></span> <span data-ttu-id="08275-104">Wenn eine <xref:System.Threading.Tasks.Parallel.ForEach%2A>-Schleife ausgeführt wird, wird die Quellauflistung in mehrere Partitionen unterteilt.</span><span class="sxs-lookup"><span data-stu-id="08275-104">When a <xref:System.Threading.Tasks.Parallel.ForEach%2A> loop executes, it divides its source collection into multiple partitions.</span></span> <span data-ttu-id="08275-105">Jede Partition besitzt eine eigene Kopie der partitionslokalen Variable.</span><span class="sxs-lookup"><span data-stu-id="08275-105">Each partition has its own copy of the partition-local variable.</span></span> <span data-ttu-id="08275-106">Eine partitionslokale Variable ähnelt einer [threadlokalen Variable](xref:System.Threading.ThreadLocal%601). Der Unterschied besteht darin, dass mehrere Partitionen in einem einzelnen Thread ausgeführt werden können.</span><span class="sxs-lookup"><span data-stu-id="08275-106">A partition-local variable is similar to a [thread-local variable](xref:System.Threading.ThreadLocal%601), except that multiple partitions can run on a single thread.</span></span>

<span data-ttu-id="08275-107">Der Code und die Parameter in diesem Beispiel ähneln stark der entsprechenden <xref:System.Threading.Tasks.Parallel.For%2A>-Methode.</span><span class="sxs-lookup"><span data-stu-id="08275-107">The code and parameters in this example closely resemble the corresponding <xref:System.Threading.Tasks.Parallel.For%2A> method.</span></span> <span data-ttu-id="08275-108">Weitere Informationen finden Sie unter [Gewusst wie: Schreiben einer Parallel.For-Schleife mit threadlokalen Variablen](how-to-write-a-parallel-for-loop-with-thread-local-variables.md).</span><span class="sxs-lookup"><span data-stu-id="08275-108">For more information, see [How to: Write a Parallel.For Loop with Thread-Local Variables](how-to-write-a-parallel-for-loop-with-thread-local-variables.md).</span></span>

<span data-ttu-id="08275-109">Um eine partitionslokale Variable in einer <xref:System.Threading.Tasks.Parallel.ForEach%2A>-Schleife verwenden zu können, müssen Sie eine der Methodenüberladungen aufrufen, die zwei Typparameter erhält.</span><span class="sxs-lookup"><span data-stu-id="08275-109">To use a partition-local variable in a <xref:System.Threading.Tasks.Parallel.ForEach%2A> loop, you must call one of the method overloads that takes two type parameters.</span></span> <span data-ttu-id="08275-110">Der erste Typparameter, `TSource`, gibt den Typ des Quellelements, der zweite Typparameter, `TLocal`, den Typ der partitionslokalen Variable an.</span><span class="sxs-lookup"><span data-stu-id="08275-110">The first type parameter, `TSource`, specifies the type of the source element, and the second type parameter, `TLocal`, specifies the type of the partition-local variable.</span></span>

## <a name="example"></a><span data-ttu-id="08275-111">Beispiel</span><span class="sxs-lookup"><span data-stu-id="08275-111">Example</span></span>

<span data-ttu-id="08275-112">Im folgenden Beispiel wird die <xref:System.Threading.Tasks.Parallel.ForEach%60%602%28System.Collections.Generic.IEnumerable%7B%60%600%7D%2CSystem.Func%7B%60%601%7D%2CSystem.Func%7B%60%600%2CSystem.Threading.Tasks.ParallelLoopState%2C%60%601%2C%60%601%7D%2CSystem.Action%7B%60%601%7D%29?displayProperty=nameWithType>-Überladung aufgerufen, um die Summe eines Arrays mit einer Million Elementen zu berechnen.</span><span class="sxs-lookup"><span data-stu-id="08275-112">The following example calls the <xref:System.Threading.Tasks.Parallel.ForEach%60%602%28System.Collections.Generic.IEnumerable%7B%60%600%7D%2CSystem.Func%7B%60%601%7D%2CSystem.Func%7B%60%600%2CSystem.Threading.Tasks.ParallelLoopState%2C%60%601%2C%60%601%7D%2CSystem.Action%7B%60%601%7D%29?displayProperty=nameWithType> overload to compute the sum of an array of one million elements.</span></span> <span data-ttu-id="08275-113">Diese Überladung hat vier Parameter:</span><span class="sxs-lookup"><span data-stu-id="08275-113">This overload has four parameters:</span></span>

- <span data-ttu-id="08275-114">`source` ist die Datenquelle.</span><span class="sxs-lookup"><span data-stu-id="08275-114">`source`, which is the data source.</span></span> <span data-ttu-id="08275-115">Der Parameter muss <xref:System.Collections.Generic.IEnumerable%601> implementieren.</span><span class="sxs-lookup"><span data-stu-id="08275-115">It must implement <xref:System.Collections.Generic.IEnumerable%601>.</span></span> <span data-ttu-id="08275-116">Die Datenquelle in unserem Beispiel ist `IEnumerable<Int32>`-Objekt mit einer Million Mitgliedern, das von der <xref:System.Linq.Enumerable.Range%2A?displayProperty=nameWithType>-Methode zurückgegeben wird.</span><span class="sxs-lookup"><span data-stu-id="08275-116">The data source in our example is the one million member `IEnumerable<Int32>` object returned by the <xref:System.Linq.Enumerable.Range%2A?displayProperty=nameWithType> method.</span></span>

- <span data-ttu-id="08275-117">`localInit` oder die Funktion, die die partitionslokale Variable initialisiert.</span><span class="sxs-lookup"><span data-stu-id="08275-117">`localInit`, or the function that initializes the partition-local variable.</span></span> <span data-ttu-id="08275-118">Diese Funktion wird einmal für jede Partition aufgerufen, in der der <xref:System.Threading.Tasks.Parallel.ForEach%2A?displayProperty=nameWithType>-Vorgang ausgeführt wird.</span><span class="sxs-lookup"><span data-stu-id="08275-118">This function is called once for each partition in which the <xref:System.Threading.Tasks.Parallel.ForEach%2A?displayProperty=nameWithType> operation executes.</span></span> <span data-ttu-id="08275-119">In unserem Beispiel wird die partitionslokale Variable auf 0 (null) initialisiert.</span><span class="sxs-lookup"><span data-stu-id="08275-119">Our example initializes the partition-local variable to zero.</span></span>

- <span data-ttu-id="08275-120">`body`, ein <xref:System.Func%604>-Objekt, wird von der parallelen Schleife in jeder Iteration der Schleife aufgerufen.</span><span class="sxs-lookup"><span data-stu-id="08275-120">`body`, a <xref:System.Func%604> that is invoked by the parallel loop on each iteration of the loop.</span></span> <span data-ttu-id="08275-121">Die Signatur lautet `Func\<TSource, ParallelLoopState, TLocal, TLocal>`.</span><span class="sxs-lookup"><span data-stu-id="08275-121">Its signature is `Func\<TSource, ParallelLoopState, TLocal, TLocal>`.</span></span> <span data-ttu-id="08275-122">Sie stellen den Code für den Delegaten bereit, und die Schleife übergibt die folgenden Eingabeparameter:</span><span class="sxs-lookup"><span data-stu-id="08275-122">You supply the code for the delegate, and the loop passes in the input parameters, which are:</span></span>

  - <span data-ttu-id="08275-123">Das aktuelle Element von <xref:System.Collections.Generic.IEnumerable%601>.</span><span class="sxs-lookup"><span data-stu-id="08275-123">The current element of the <xref:System.Collections.Generic.IEnumerable%601>.</span></span>

  - <span data-ttu-id="08275-124">Eine <xref:System.Threading.Tasks.ParallelLoopState>-Variable, die Sie im Code Ihres Delegaten verwenden können, um den Zustand der Schleife zu untersuchen.</span><span class="sxs-lookup"><span data-stu-id="08275-124">A <xref:System.Threading.Tasks.ParallelLoopState> variable that you can use in your delegate's code to examine the state of the loop.</span></span>

  - <span data-ttu-id="08275-125">Die partitionslokale Variable.</span><span class="sxs-lookup"><span data-stu-id="08275-125">The partition-local variable.</span></span>

  <span data-ttu-id="08275-126">Ihr Delegat gibt die partitionslokale Variable zurück, die dann an die nächste Iteration der Schleife übergeben wird, die in dieser bestimmten Partition ausgeführt wird.</span><span class="sxs-lookup"><span data-stu-id="08275-126">Your delegate returns the partition-local variable, which is then passed to the next iteration of the loop that executes in that particular partition.</span></span> <span data-ttu-id="08275-127">Jede Schleifenpartition behält eine separate Instanz dieser Variable bei.</span><span class="sxs-lookup"><span data-stu-id="08275-127">Each loop partition maintains a separate instance of this variable.</span></span>

  <span data-ttu-id="08275-128">In dem Beispiel fügt der Delegat den Wert jeder ganzen Zahl zur partitionslokalen Variable hinzu, die einen laufenden Gesamtbetrag der Werte der ganzzahligen Elemente in dieser Partition beibehält.</span><span class="sxs-lookup"><span data-stu-id="08275-128">In the example, the delegate adds the value of each integer to the partition-local variable, which maintains a running total of the values of the integer elements in that partition.</span></span>

- <span data-ttu-id="08275-129">`localFinally`, ein `Action<TLocal>`-Delegat, der von <xref:System.Threading.Tasks.Parallel.ForEach%2A?displayProperty=nameWithType> aufgerufen wird, wenn die Schleifenvorgänge in jeder Partition abgeschlossen wurden.</span><span class="sxs-lookup"><span data-stu-id="08275-129">`localFinally`, an `Action<TLocal>` delegate that the <xref:System.Threading.Tasks.Parallel.ForEach%2A?displayProperty=nameWithType> invokes when the looping operations in each partition have completed.</span></span> <span data-ttu-id="08275-130">Die <xref:System.Threading.Tasks.Parallel.ForEach%2A?displayProperty=nameWithType>-Methode übergibt Ihrem `Action<TLocal>`-Delegaten den ersten Wert der partitionslokalen Variable für diese Schleifenpartition, und Sie stellen den Code bereit, der die erforderliche Aktion zum Kombinieren des Ergebnisses von dieser Partition mit den Ergebnissen der anderen Partitionen bereitstellt.</span><span class="sxs-lookup"><span data-stu-id="08275-130">The <xref:System.Threading.Tasks.Parallel.ForEach%2A?displayProperty=nameWithType> method passes your `Action<TLocal>` delegate the final value of the partition-local variable for this loop partition, and you provide the code that performs the required action for combining the result from this partition with the results from the other partitions.</span></span> <span data-ttu-id="08275-131">Dieser Delegat kann von mehreren Aufgaben gleichzeitig aufgerufen werden.</span><span class="sxs-lookup"><span data-stu-id="08275-131">This delegate can be invoked concurrently by multiple tasks.</span></span> <span data-ttu-id="08275-132">Darum verwendet das Beispiel die <xref:System.Threading.Interlocked.Add%28System.Int32%40%2CSystem.Int32%29?displayProperty=nameWithType>-Methode, um den Zugriff auf die Variable `total` zu synchronisieren.</span><span class="sxs-lookup"><span data-stu-id="08275-132">Because of this, the example uses the <xref:System.Threading.Interlocked.Add%28System.Int32%40%2CSystem.Int32%29?displayProperty=nameWithType> method to synchronize access to the `total` variable.</span></span> <span data-ttu-id="08275-133">Da der Delegattyp ein <xref:System.Action%601>-Objekt ist, ist kein Rückgabewert vorhanden.</span><span class="sxs-lookup"><span data-stu-id="08275-133">Because the delegate type is an <xref:System.Action%601>, there is no return value.</span></span>

[!code-csharp[TPL_Parallel#04](../../../samples/snippets/csharp/VS_Snippets_Misc/tpl_parallel/cs/foreachthreadlocal.cs#04)]
[!code-vb[TPL_Parallel#04](../../../samples/snippets/visualbasic/VS_Snippets_Misc/tpl_parallel/vb/foreachthreadlocal.vb#04)]

## <a name="see-also"></a><span data-ttu-id="08275-134">Weitere Informationen</span><span class="sxs-lookup"><span data-stu-id="08275-134">See also</span></span>

- [<span data-ttu-id="08275-135">Datenparallelität</span><span class="sxs-lookup"><span data-stu-id="08275-135">Data Parallelism</span></span>](data-parallelism-task-parallel-library.md)
- [<span data-ttu-id="08275-136">How to: Write a Parallel.For Loop with Thread-Local Variables (Vorgehensweise: Schreiben einer Parallel.For-Schleife mit thread-lokalen Variablen)</span><span class="sxs-lookup"><span data-stu-id="08275-136">How to: Write a Parallel.For Loop with Thread-Local Variables</span></span>](how-to-write-a-parallel-for-loop-with-thread-local-variables.md)
- [<span data-ttu-id="08275-137">Lambdaausdrücke in PLINQ und TPL</span><span class="sxs-lookup"><span data-stu-id="08275-137">Lambda Expressions in PLINQ and TPL</span></span>](lambda-expressions-in-plinq-and-tpl.md)
