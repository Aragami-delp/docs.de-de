---
title: 'Vorgehensweise: Schreiben einer einfachen Parallel.For-Schleife'
description: Erfahren Sie, wie Sie Parallel.For-Schleifen in .NET erstellen, bei denen Sie weder die Schleife abbrechen müssen noch Schleifeniterationen unterbrechen oder einen threadlokalen Zustand beibehalten.
ms.date: 03/30/2017
ms.technology: dotnet-standard
dev_langs:
- csharp
- vb
helpviewer_keywords:
- Parallel.For, How to Write
- for loop, parallel construction in .NET
- parallel for loops, how to use
ms.assetid: 9029ba7f-a9d1-4526-8c84-c88716dba5d4
ms.openlocfilehash: 8307f2205653fbd213d824acffc405ee97580166
ms.sourcegitcommit: 7137e12f54c4e83a94ae43ec320f8cf59c1772ea
ms.translationtype: HT
ms.contentlocale: de-DE
ms.lasthandoff: 06/10/2020
ms.locfileid: "84662692"
---
# <a name="how-to-write-a-simple-parallelfor-loop"></a><span data-ttu-id="a48ca-103">Vorgehensweise: Schreiben einer einfachen Parallel.For-Schleife</span><span class="sxs-lookup"><span data-stu-id="a48ca-103">How to: Write a Simple Parallel.For Loop</span></span>

<span data-ttu-id="a48ca-104">Dieses Thema enthält zwei Beispiele, die die <xref:System.Threading.Tasks.Parallel.For%2A?displayProperty=nameWithType>-Methode veranschaulichen.</span><span class="sxs-lookup"><span data-stu-id="a48ca-104">This topic contains two examples that illustrate the <xref:System.Threading.Tasks.Parallel.For%2A?displayProperty=nameWithType> method.</span></span> <span data-ttu-id="a48ca-105">Im ersten Beispiel wird die <xref:System.Threading.Tasks.Parallel.For%28System.Int64%2CSystem.Int64%2CSystem.Action%7BSystem.Int64%7D%29?displayProperty=nameWithType>-Methodenüberladung und im zweiten Beispiel wird die <xref:System.Threading.Tasks.Parallel.For%28System.Int32%2CSystem.Int32%2CSystem.Action%7BSystem.Int32%7D%29?displayProperty=nameWithType>-Überladung verwendet. Dies beiden Überladungen sind die einfachsten Überladungen der <xref:System.Threading.Tasks.Parallel.For%2A?displayProperty=nameWithType>-Methode.</span><span class="sxs-lookup"><span data-stu-id="a48ca-105">The first uses the <xref:System.Threading.Tasks.Parallel.For%28System.Int64%2CSystem.Int64%2CSystem.Action%7BSystem.Int64%7D%29?displayProperty=nameWithType> method overload, and the second uses the <xref:System.Threading.Tasks.Parallel.For%28System.Int32%2CSystem.Int32%2CSystem.Action%7BSystem.Int32%7D%29?displayProperty=nameWithType> overload, the two simplest overloads of the <xref:System.Threading.Tasks.Parallel.For%2A?displayProperty=nameWithType> method.</span></span> <span data-ttu-id="a48ca-106">Sie können diese beiden Überladungen der <xref:System.Threading.Tasks.Parallel.For%2A?displayProperty=nameWithType>-Methode verwenden, wenn keiner der folgenden Vorgänge erforderlich ist: Abbrechen der Schleife, vorzeitiges Beenden der Schleifeniterationen oder Beibehalten eines threadlokalen Zustands.</span><span class="sxs-lookup"><span data-stu-id="a48ca-106">You can use these two overloads of the <xref:System.Threading.Tasks.Parallel.For%2A?displayProperty=nameWithType> method when you do not need to cancel the loop, break out of the loop iterations, or maintain any thread-local state.</span></span>

> [!NOTE]
> <span data-ttu-id="a48ca-107">Diese Dokumentation definiert Delegaten in TPL mithilfe von Lambdaausdrücken.</span><span class="sxs-lookup"><span data-stu-id="a48ca-107">This documentation uses lambda expressions to define delegates in TPL.</span></span> <span data-ttu-id="a48ca-108">Falls Sie mit der Verwendung von Lambda-Ausdrücken in C# oder Visual Basic nicht vertraut sind, finden Sie entsprechende Informationen unter [Lambda Expressions in PLINQ and TPL (Lambda-Ausdrücke in PLINQ und TPL)](lambda-expressions-in-plinq-and-tpl.md).</span><span class="sxs-lookup"><span data-stu-id="a48ca-108">If you are not familiar with lambda expressions in C# or Visual Basic, see [Lambda Expressions in PLINQ and TPL](lambda-expressions-in-plinq-and-tpl.md).</span></span>

<span data-ttu-id="a48ca-109">Im ersten Beispiel wird die Größe der Dateien in einem einzelnen Verzeichnis berechnet.</span><span class="sxs-lookup"><span data-stu-id="a48ca-109">The first example calculates the size of files in a single directory.</span></span> <span data-ttu-id="a48ca-110">Im zweiten Beispiel wird das Produkt von zwei Matrizen berechnet.</span><span class="sxs-lookup"><span data-stu-id="a48ca-110">The second computes the product of two matrices.</span></span>

## <a name="directory-size-example"></a><span data-ttu-id="a48ca-111">Größenbeispiel für ein Verzeichnis</span><span class="sxs-lookup"><span data-stu-id="a48ca-111">Directory size example</span></span>

<span data-ttu-id="a48ca-112">Dieses Beispiel ist ein einfaches Befehlszeilenprogramm, das die Gesamtgröße der Dateien in einem Verzeichnis berechnet.</span><span class="sxs-lookup"><span data-stu-id="a48ca-112">This example is a simple command-line utility that calculates the total size of files in a directory.</span></span> <span data-ttu-id="a48ca-113">Das Programm erwartet einen einzelnen Verzeichnispfad als Argument und meldet die Anzahl sowie die Gesamtgröße der Dateien in diesem Verzeichnis.</span><span class="sxs-lookup"><span data-stu-id="a48ca-113">It expects a single directory path as an argument, and reports the number and total size of the files in that directory.</span></span> <span data-ttu-id="a48ca-114">Nachdem das Programm überprüft hat, ob das Verzeichnis vorhanden ist, verwendet es die <xref:System.Threading.Tasks.Parallel.For%2A?displayProperty=nameWithType>-Methode, um die Dateien im Verzeichnis aufzuzählen und deren Größen zu bestimmen.</span><span class="sxs-lookup"><span data-stu-id="a48ca-114">After verifying that the directory exists, it uses the <xref:System.Threading.Tasks.Parallel.For%2A?displayProperty=nameWithType> method to enumerate the files in the directory and determine their file sizes.</span></span> <span data-ttu-id="a48ca-115">Jede Dateigröße wird dann der `totalSize`-Variablen hinzugefügt.</span><span class="sxs-lookup"><span data-stu-id="a48ca-115">Each file size is then added to the `totalSize` variable.</span></span> <span data-ttu-id="a48ca-116">Beachten Sie, dass die Addition durch Aufrufen der<xref:System.Threading.Interlocked.Add%2A?displayProperty=nameWithType>-Methode ausgeführt wird, sodass die Addition als atomarer Vorgang ausgeführt wird.</span><span class="sxs-lookup"><span data-stu-id="a48ca-116">Note that the addition is performed by calling the <xref:System.Threading.Interlocked.Add%2A?displayProperty=nameWithType> so that the addition is performed as an atomic operation.</span></span> <span data-ttu-id="a48ca-117">Andernfalls könnten mehrere Aufgaben versuchen, die `totalSize`-Variable gleichzeitig zu aktualisieren.</span><span class="sxs-lookup"><span data-stu-id="a48ca-117">Otherwise, multiple tasks could try to update the `totalSize` variable simultaneously.</span></span>

[!code-csharp[Conceptual.Parallel.For#1](../../../samples/snippets/csharp/VS_Snippets_CLR/conceptual.parallel.for/cs/for1.cs#1)]
[!code-vb[Conceptual.Parallel.For#1](../../../samples/snippets/visualbasic/VS_Snippets_CLR/conceptual.parallel.for/vb/for1.vb#1)]

## <a name="matrix-and-stopwatch-example"></a><span data-ttu-id="a48ca-118">Matrix- und Stopwatch-Beispiel</span><span class="sxs-lookup"><span data-stu-id="a48ca-118">Matrix and stopwatch example</span></span>

<span data-ttu-id="a48ca-119">In diesem Beispiel wird die <xref:System.Threading.Tasks.Parallel.For%2A?displayProperty=nameWithType>-Methode verwendet, um das Produkt von zwei Matrizen zu berechnen.</span><span class="sxs-lookup"><span data-stu-id="a48ca-119">This example uses the <xref:System.Threading.Tasks.Parallel.For%2A?displayProperty=nameWithType> method to compute the product of two matrices.</span></span> <span data-ttu-id="a48ca-120">In diesem Beispiel wird außerdem gezeigt, wie die <xref:System.Diagnostics.Stopwatch?displayProperty=nameWithType>-Klasse verwendet werden kann, um die Leistung einer parallelen Schleife mit der einer nicht parallelen Schleife zu vergleichen.</span><span class="sxs-lookup"><span data-stu-id="a48ca-120">It also shows how to use the <xref:System.Diagnostics.Stopwatch?displayProperty=nameWithType> class to compare the performance of a parallel loop with a non-parallel loop.</span></span> <span data-ttu-id="a48ca-121">Weil in dem Beispiel sehr viel Ausgabe generiert werden kann, wird in ihm ermöglicht, Ausgabe in eine Datei umzuleiten.</span><span class="sxs-lookup"><span data-stu-id="a48ca-121">Note that, because it can generate a large volume of output, the example allows output to be redirected to a file.</span></span>

[!code-csharp[TPL_Parallel#01](../../../samples/snippets/csharp/VS_Snippets_Misc/tpl_parallel/cs/simpleparallelfor.cs#01)]
[!code-vb[TPL_Parallel#01](../../../samples/snippets/visualbasic/VS_Snippets_Misc/tpl_parallel/vb/simpleparallelfor.vb#01)]

<span data-ttu-id="a48ca-122">Wenn Code, einschließlich Schleifen, parallelisiert wird, besteht ein wichtiges Ziel darin, die Prozessoren so viel wie möglich zu nutzen, ohne den Punkt für die Parallelisierung zu überschreiten, ab dem der Aufwand für die parallele Verarbeitung jegliche Leistungsvorteile negiert.</span><span class="sxs-lookup"><span data-stu-id="a48ca-122">When parallelizing any code, including loops, one important goal is to utilize the processors as much as possible without over parallelizing to the point where the overhead for parallel processing negates any performance benefits.</span></span> <span data-ttu-id="a48ca-123">In diesem speziellen Beispiel wird nur die äußere Schleife parallelisiert, weil in der inneren Schleife nicht sehr viel Arbeit ausgeführt wird.</span><span class="sxs-lookup"><span data-stu-id="a48ca-123">In this particular example, only the outer loop is parallelized because there is not very much work performed in the inner loop.</span></span> <span data-ttu-id="a48ca-124">Die Kombination aus einer kleinen Menge von Arbeit und unerwünschten Cacheeffekten kann zu Leistungseinbußen in geschachtelten parallelen Schleifen führen.</span><span class="sxs-lookup"><span data-stu-id="a48ca-124">The combination of a small amount of work and undesirable cache effects can result in performance degradation in nested parallel loops.</span></span> <span data-ttu-id="a48ca-125">Daher ist eine Parallelisierung der äußeren Schleife die beste Möglichkeit, die Vorteile der Parallelität in den meisten Systemen zu maximieren.</span><span class="sxs-lookup"><span data-stu-id="a48ca-125">Therefore, parallelizing the outer loop only is the best way to maximize the benefits of concurrency on most systems.</span></span>

## <a name="the-delegate"></a><span data-ttu-id="a48ca-126">Der Delegat</span><span class="sxs-lookup"><span data-stu-id="a48ca-126">The Delegate</span></span>

<span data-ttu-id="a48ca-127">Der dritte Parameter dieser Überladung von <xref:System.Threading.Tasks.Parallel.For%2A> ist ein Delegat des Typs `Action<int>` in C# oder `Action(Of Integer)` in Visual Basic.</span><span class="sxs-lookup"><span data-stu-id="a48ca-127">The third parameter of this overload of <xref:System.Threading.Tasks.Parallel.For%2A> is a delegate of type `Action<int>` in C# or `Action(Of Integer)` in Visual Basic.</span></span> <span data-ttu-id="a48ca-128">Ein `Action`-Delegat gibt unabhängig davon, ob er keinen, einen oder sechzehn Typparameter hat, immer „void“ zurück.</span><span class="sxs-lookup"><span data-stu-id="a48ca-128">An `Action` delegate, whether it has zero, one or sixteen type parameters, always returns void.</span></span> <span data-ttu-id="a48ca-129">In Visual Basic wird das Verhalten eines `Action`-Delegaten mit einer `Sub`-Prozedur definiert.</span><span class="sxs-lookup"><span data-stu-id="a48ca-129">In Visual Basic, the behavior of an `Action` is defined with a `Sub`.</span></span> <span data-ttu-id="a48ca-130">Im Beispiel wird ein Lambdaausdruck verwendet, um den Delegaten zu erstellen. Sie können den Delegaten jedoch auch auf andere Art und Weise erstellen.</span><span class="sxs-lookup"><span data-stu-id="a48ca-130">The example uses a lambda expression to create the delegate, but you can create the delegate in other ways as well.</span></span> <span data-ttu-id="a48ca-131">Weitere Informationen finden Sie unter [Lambdaausdrücke in PLINQ und TPL](lambda-expressions-in-plinq-and-tpl.md).</span><span class="sxs-lookup"><span data-stu-id="a48ca-131">For more information, see [Lambda Expressions in PLINQ and TPL](lambda-expressions-in-plinq-and-tpl.md).</span></span>

## <a name="the-iteration-value"></a><span data-ttu-id="a48ca-132">Der Iterationswert</span><span class="sxs-lookup"><span data-stu-id="a48ca-132">The Iteration Value</span></span>

<span data-ttu-id="a48ca-133">Der Delegat hat einen einzelnen Eingabeparameter, dessen Wert der aktuellen Iteration entspricht.</span><span class="sxs-lookup"><span data-stu-id="a48ca-133">The delegate takes a single input parameter whose value is the current iteration.</span></span> <span data-ttu-id="a48ca-134">Dieser Iterationswert wird von der Runtime bereitgestellt, und sein Startwert ist der Index des ersten Elements im Segment (Partition) der Quelle, die im aktuellen Thread verarbeitet wird.</span><span class="sxs-lookup"><span data-stu-id="a48ca-134">This iteration value is supplied by the runtime and its starting value is the index of the first element on the segment (partition) of the source that is being processed on the current thread.</span></span>

<span data-ttu-id="a48ca-135">Wenn Sie mehr Kontrolle über den Parallelitätsumfang benötigen, verwenden Sie eine der Überladungen, die einen <xref:System.Threading.Tasks.ParallelOptions?displayProperty=nameWithType>-Eingabeparameter hat, wie z. B.:<xref:System.Threading.Tasks.Parallel.For%28System.Int32%2CSystem.Int32%2CSystem.Threading.Tasks.ParallelOptions%2CSystem.Action%7BSystem.Int32%2CSystem.Threading.Tasks.ParallelLoopState%7D%29?displayProperty=nameWithType>.</span><span class="sxs-lookup"><span data-stu-id="a48ca-135">If you require more control over the concurrency level, use one of the overloads that takes a <xref:System.Threading.Tasks.ParallelOptions?displayProperty=nameWithType> input parameter, such as: <xref:System.Threading.Tasks.Parallel.For%28System.Int32%2CSystem.Int32%2CSystem.Threading.Tasks.ParallelOptions%2CSystem.Action%7BSystem.Int32%2CSystem.Threading.Tasks.ParallelLoopState%7D%29?displayProperty=nameWithType>.</span></span>

## <a name="return-value-and-exception-handling"></a><span data-ttu-id="a48ca-136">Rückgabewert und Ausnahmebehandlung</span><span class="sxs-lookup"><span data-stu-id="a48ca-136">Return Value and Exception Handling</span></span>

<span data-ttu-id="a48ca-137"><xref:System.Threading.Tasks.Parallel.For%2A> gibt ein <xref:System.Threading.Tasks.ParallelLoopResult?displayProperty=nameWithType>-Objekt zurück, wenn alle Threads abgeschlossen sind.</span><span class="sxs-lookup"><span data-stu-id="a48ca-137"><xref:System.Threading.Tasks.Parallel.For%2A> returns a <xref:System.Threading.Tasks.ParallelLoopResult?displayProperty=nameWithType> object when all threads have completed.</span></span> <span data-ttu-id="a48ca-138">Dieser Rückgabewert ist hilfreich, wenn Sie eine Schleifeniteration manuell stoppen oder abbrechen, weil im <xref:System.Threading.Tasks.ParallelLoopResult>-Objekt Informationen wie die letzte Iteration, die vollständig ausgeführt wurde, gespeichert sind.</span><span class="sxs-lookup"><span data-stu-id="a48ca-138">This return value is useful when you are stopping or breaking loop iteration manually, because the <xref:System.Threading.Tasks.ParallelLoopResult> stores information such as the last iteration that ran to completion.</span></span> <span data-ttu-id="a48ca-139">Tritt in einem der Threads mindestens eine Ausnahme auf, wird eine <xref:System.AggregateException?displayProperty=nameWithType> ausgelöst.</span><span class="sxs-lookup"><span data-stu-id="a48ca-139">If one or more exceptions occur on one of the threads, a <xref:System.AggregateException?displayProperty=nameWithType> will be thrown.</span></span>

<span data-ttu-id="a48ca-140">Im Code dieses Beispiels wird der Rückgabewert von <xref:System.Threading.Tasks.Parallel.For%2A> nicht verwendet.</span><span class="sxs-lookup"><span data-stu-id="a48ca-140">In the code in this example, the return value of <xref:System.Threading.Tasks.Parallel.For%2A> is not used.</span></span>

## <a name="analysis-and-performance"></a><span data-ttu-id="a48ca-141">Analyse und Leistung</span><span class="sxs-lookup"><span data-stu-id="a48ca-141">Analysis and Performance</span></span>

<span data-ttu-id="a48ca-142">Mit dem Leistung-Assistenten können die CPU-Nutzung auf Ihrem Computer anzeigen.</span><span class="sxs-lookup"><span data-stu-id="a48ca-142">You can use the Performance Wizard to view CPU usage on your computer.</span></span> <span data-ttu-id="a48ca-143">Zum Experimentieren erhöhen Sie die Anzahl von Spalten und Zeilen in den Matrizen.</span><span class="sxs-lookup"><span data-stu-id="a48ca-143">As an experiment, increase the number of columns and rows in the matrices.</span></span> <span data-ttu-id="a48ca-144">Je größer die Matrizen sind, desto größer ist der Leistungsunterschied zwischen der parallelen und sequenziellen Version der Berechnung.</span><span class="sxs-lookup"><span data-stu-id="a48ca-144">The larger the matrices, the greater the performance difference between the parallel and sequential versions of the computation.</span></span> <span data-ttu-id="a48ca-145">Wenn die Matrix klein ist, wird die sequenzielle Version wegen des Mehraufwands für das Einrichten der parallelen Schleife schneller ausgeführt.</span><span class="sxs-lookup"><span data-stu-id="a48ca-145">When the matrix is small, the sequential version will run faster because of the overhead in setting up the parallel loop.</span></span>

<span data-ttu-id="a48ca-146">Synchrone Aufrufe freigegebener Ressourcen, wie die Konsole oder das Dateisystem, verringern die Leistung einer parallelen Schleife erheblich.</span><span class="sxs-lookup"><span data-stu-id="a48ca-146">Synchronous calls to shared resources, like the Console or the File System, will significantly degrade the performance of a parallel loop.</span></span> <span data-ttu-id="a48ca-147">Wenn Sie die Leistung messen, sollten Sie möglichst versuchen, Aufrufe wie <xref:System.Console.WriteLine%2A?displayProperty=nameWithType> innerhalb der Schleife zu vermeiden.</span><span class="sxs-lookup"><span data-stu-id="a48ca-147">When measuring performance, try to avoid calls such as <xref:System.Console.WriteLine%2A?displayProperty=nameWithType> within the loop.</span></span>

## <a name="compile-the-code"></a><span data-ttu-id="a48ca-148">Kompilieren des Codes</span><span class="sxs-lookup"><span data-stu-id="a48ca-148">Compile the Code</span></span>

<span data-ttu-id="a48ca-149">Kopieren Sie diesen Code, und fügen Sie ihn in ein Visual Studio-Projekt ein.</span><span class="sxs-lookup"><span data-stu-id="a48ca-149">Copy and paste this code into a Visual Studio project.</span></span>

## <a name="see-also"></a><span data-ttu-id="a48ca-150">Siehe auch</span><span class="sxs-lookup"><span data-stu-id="a48ca-150">See also</span></span>

- <xref:System.Threading.Tasks.Parallel.For%2A>
- <xref:System.Threading.Tasks.Parallel.ForEach%2A>
- [<span data-ttu-id="a48ca-151">Datenparallelität</span><span class="sxs-lookup"><span data-stu-id="a48ca-151">Data Parallelism</span></span>](data-parallelism-task-parallel-library.md)
- [<span data-ttu-id="a48ca-152">Parallele Programmierung</span><span class="sxs-lookup"><span data-stu-id="a48ca-152">Parallel Programming</span></span>](index.md)
